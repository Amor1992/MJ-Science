<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ æ¨ç®±å­ - MJ æ¸¸æˆä¹å›­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #1a1a3e 0%, #2a2a5e 50%, #3a3a7e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* æ ‡é¢˜ */
        h1 {
            color: #ffd700;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            z-index: 10;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        #game-area {
            position: relative;
            z-index: 10;
            margin-bottom: 20px;
        }

        #game-canvas {
            border: 4px solid #ffd700;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            background: #2c3e50;
        }

        /* ä¿¡æ¯é¢æ¿ */
        #info-panel {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            z-index: 10;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .info-box h3 {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-box .value {
            font-size: 24px;
            font-weight: bold;
        }

        /* æ§åˆ¶æŒ‰é’® */
        #controls {
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        .control-btn {
            padding: 12px 24px;
            background: rgba(26, 84, 144, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(26, 84, 144, 1);
            transform: scale(1.05);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å…³å¡é€‰æ‹© */
        #level-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
        }

        .level-btn {
            width: 50px;
            height: 50px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-btn:hover {
            background: rgba(26, 84, 144, 0.8);
            transform: scale(1.1);
        }

        .level-btn.active {
            background: rgba(155, 89, 182, 0.9);
            border-color: rgba(255, 215, 0, 0.8);
        }

        .level-btn.completed {
            border-color: #27ae60;
        }

        .level-btn.completed::after {
            content: 'âœ“';
            position: absolute;
            font-size: 12px;
            color: #27ae60;
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶ */
        #mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 5px;
        }

        .d-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            user-select: none;
        }

        .d-btn:active {
            background: rgba(26, 84, 144, 1);
            transform: scale(0.95);
        }

        .d-btn.up { grid-column: 2; grid-row: 1; }
        .d-btn.left { grid-column: 1; grid-row: 2; }
        .d-btn.right { grid-column: 3; grid-row: 2; }
        .d-btn.down { grid-column: 2; grid-row: 3; }

        @media (max-width: 768px) {
            #mobile-controls {
                display: block;
            }

            h1 {
                font-size: 24px;
            }

            #info-panel {
                flex-direction: row;
                gap: 10px;
            }

            .info-box {
                padding: 10px 15px;
            }

            .info-box .value {
                font-size: 18px;
            }

            .control-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            #game-canvas {
                max-width: 90vw;
                max-height: 50vh;
            }
        }

        /* å®Œæˆå¥–åŠ±å±‚ */
        #reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }

        #medal {
            font-size: 120px;
            animation: medal-pop 0.6s ease-out, medal-glow 2s infinite;
        }

        @keyframes medal-pop {
            0% { transform: scale(0) rotate(-180deg); }
            80% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes medal-glow {
            0%, 100% { filter: drop-shadow(0 0 10px #ffd700); }
            50% { filter: drop-shadow(0 0 30px #ffd700); }
        }

        #reward-text {
            color: #ffd700;
            font-size: 36px;
            margin-top: 20px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        #reward-stars {
            color: #f39c12;
            font-size: 48px;
            margin-top: 15px;
        }

        #reward-stats {
            color: #fff;
            font-size: 18px;
            margin-top: 15px;
        }

        #next-btn {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
        }

        #next-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.7);
        }

        /* æç¤ºæ¡† */
        #hint-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px 40px;
            border-radius: 20px;
            border: 2px solid #ffd700;
            text-align: center;
            z-index: 300;
            max-width: 400px;
            display: none;
        }

        #hint-box h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 24px;
        }

        #hint-box p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
        }

        #hint-box button {
            margin-top: 20px;
            padding: 12px 30px;
            background: rgba(26, 84, 144, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- æ˜Ÿæ˜ŸèƒŒæ™¯å®¹å™¨ -->
    <div id="stars-container"></div>

    <div id="game-container">
        <h1>ğŸ“¦ æ¨ç®±å­</h1>

        <!-- å…³å¡é€‰æ‹© -->
        <div id="level-selector"></div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <div id="game-area">
            <canvas id="game-canvas" width="480" height="480"></canvas>
        </div>

        <!-- ä¿¡æ¯é¢æ¿ -->
        <div id="info-panel">
            <div class="info-box">
                <h3>å…³å¡</h3>
                <div class="value" id="level-display">1</div>
            </div>
            <div class="info-box">
                <h3>æ­¥æ•°</h3>
                <div class="value" id="moves-display">0</div>
            </div>
            <div class="info-box">
                <h3>æœ€ä½³</h3>
                <div class="value" id="best-display">-</div>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="control-btn" onclick="game.undo()">â†©ï¸ æ’¤é”€</button>
            <button class="control-btn" onclick="game.reset()">ğŸ”„ é‡ç½®</button>
            <button class="control-btn" onclick="game.showHint()">ğŸ’¡ æç¤º</button>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æ§åˆ¶ -->
    <div id="mobile-controls">
        <div class="d-pad">
            <div class="d-btn up" onclick="game.move(0, -1)">â¬†ï¸</div>
            <div class="d-btn left" onclick="game.move(-1, 0)">â¬…ï¸</div>
            <div class="d-btn right" onclick="game.move(1, 0)">â¡ï¸</div>
            <div class="d-btn down" onclick="game.move(0, 1)">â¬‡ï¸</div>
        </div>
    </div>

    <!-- å®Œæˆå¥–åŠ±å±‚ -->
    <div id="reward-overlay">
        <div id="medal">ğŸ‰</div>
        <div id="reward-text">å…³å¡å®Œæˆï¼</div>
        <div id="reward-stars">â­â­â­</div>
        <div id="reward-stats">
            ç”¨äº† <span id="final-moves">0</span> æ­¥<br>
            æœ€ä½³è®°å½•: <span id="final-best">-</span> æ­¥
        </div>
        <button id="next-btn" onclick="game.nextLevel()">ä¸‹ä¸€å…³ â¡ï¸</button>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="hint-box">
        <h2>ğŸ’¡ æ¸¸æˆæç¤º</h2>
        <p>ğŸ¯ ç›®æ ‡ï¼šæŠŠæ‰€æœ‰ç®±å­ï¼ˆğŸ“¦ï¼‰æ¨åˆ°ç›®æ ‡ä½ç½®ï¼ˆâŒï¼‰ä¸Š</p>
        <p>âš ï¸ æ³¨æ„ï¼šç®±å­åªèƒ½æ¨ï¼Œä¸èƒ½æ‹‰ï¼</p>
        <p>ğŸ’¡ æç¤ºï¼šå…ˆæ¨ç¦»å¢™è§’çš„ç®±å­ï¼Œä¸è¦æŠŠç®±å­æ¨åˆ°æ­»è§’ï¼</p>
        <p>âŒ¨ï¸ æ“ä½œï¼šæ–¹å‘é”®æˆ– WASD ç§»åŠ¨</p>
        <button onclick="game.closeHint()">çŸ¥é“äº†</button>
    </div>

    <script>
        // ==================== å…³å¡æ•°æ® ====================

        const LEVELS = [
            // å…³å¡ 1 - å…¥é—¨
            {
                map: [
                    "  #####",
                    "###   #",
                    "#   $ #",
                    "#  .  #",
                    "#  @  #",
                    "#######"
                ],
                best: 5
            },
            // å…³å¡ 2
            {
                map: [
                    "  #####",
                    "###   #",
                    "# $ # #",
                    "#  .  #",
                    "#  @  #",
                    "#######"
                ],
                best: 8
            },
            // å…³å¡ 3
            {
                map: [
                    "######",
                    "#    #",
                    "# $  #",
                    "# .@ #",
                    "#  $ #",
                    "#  . #",
                    "######"
                ],
                best: 12
            },
            // å…³å¡ 4
            {
                map: [
                    "  ####",
                    "###  #",
                    "# .  #",
                    "#  $ #",
                    "# .  #",
                    "#  $ #",
                    "# .  #",
                    "###@ #",
                    "  ####"
                ],
                best: 16
            },
            // å…³å¡ 5
            {
                map: [
                    "#######",
                    "#  .  #",
                    "# $ $ #",
                    "# .@. #",
                    "# $ $ #",
                    "#  .  #",
                    "#######"
                ],
                best: 20
            },
            // å…³å¡ 6
            {
                map: [
                    "  #####",
                    "  #   #",
                    "  #$  #",
                    "###  $##",
                    "#  $ $ #",
                    "#. .@. #",
                    "#  $ $ #",
                    "###  $##",
                    "  #$  #",
                    "  #   #",
                    "  #####"
                ],
                best: 30
            },
            // å…³å¡ 7
            {
                map: [
                    "   ###",
                    "   #.#",
                    "   # #",
                    "###$ #",
                    "#  $ #",
                    "# .@ #",
                    "#  $ #",
                    "#  # #",
                    "##### #",
                    "    ###"
                ],
                best: 25
            },
            // å…³å¡ 8
            {
                map: [
                    "#######",
                    "#     #",
                    "# .$. #",
                    "#  $  #",
                    "#  $  #",
                    "# .$. #",
                    "#  @  #",
                    "#######"
                ],
                best: 28
            }
        ];

        // ==================== éŸ³æ•ˆå¼•æ“ ====================

        const AudioEngine = {
            audioContext: null,

            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },

            playMove() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 200;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.15);
            },

            playPush() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 150;
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.08);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.25);
            },

            playWin() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [523, 659, 784, 1047].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 120);
                });
            }
        };

        // ==================== æ¸¸æˆç±» ====================

        const Game = {
            currentLevel: 0,
            moves: 0,
            history: [],
            map: [],
            playerPos: { x: 0, y: 0 },
            boxes: [],
            targets: [],
            tileSize: 48,
            completedLevels: [],

            init() {
                this.loadProgress();
                this.createStars();
                this.createLevelButtons();
                this.loadLevel(0);

                // é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', (e) => {
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd', 'W', 'A', 'S', 'D'].includes(e.key)) {
                        e.preventDefault();

                        let dx = 0, dy = 0;
                        if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') dy = -1;
                        else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') dy = 1;
                        else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') dx = -1;
                        else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') dx = 1;

                        this.move(dx, dy);
                    }
                });

                // è§¦æ‘¸æ”¯æŒ
                this.setupTouchControls();

                // ç»‘å®šéŸ³é¢‘åˆå§‹åŒ–
                document.addEventListener('click', () => {
                    if (!AudioEngine.audioContext) {
                        AudioEngine.init();
                    }
                }, { once: true });

                // æ˜¾ç¤ºæç¤º
                setTimeout(() => {
                    this.showHint();
                }, 500);
            },

            loadProgress() {
                const saved = localStorage.getItem('sokoban_progress');
                if (saved) {
                    this.completedLevels = JSON.parse(saved);
                }
            },

            saveProgress() {
                localStorage.setItem('sokoban_progress', JSON.stringify(this.completedLevels));
            },

            createLevelButtons() {
                const container = document.getElementById('level-selector');
                container.innerHTML = '';

                for (let i = 0; i < LEVELS.length; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'level-btn';
                    btn.textContent = i + 1;
                    btn.onclick = () => this.loadLevel(i);

                    if (this.completedLevels.includes(i)) {
                        btn.classList.add('completed');
                    }

                    container.appendChild(btn);
                }
            },

            loadLevel(levelIndex) {
                this.currentLevel = levelIndex;
                this.moves = 0;
                this.history = [];

                const levelData = LEVELS[levelIndex];
                const map = levelData.map;

                // è§£æåœ°å›¾
                this.map = [];
                this.boxes = [];
                this.targets = [];

                for (let y = 0; y < map.length; y++) {
                    this.map[y] = [];
                    for (let x = 0; x < map[y].length; x++) {
                        const char = map[y][x];

                        if (char === '@') {
                            this.playerPos = { x, y };
                            this.map[y][x] = ' ';
                        } else if (char === '$') {
                            this.boxes.push({ x, y, onTarget: false });
                            this.map[y][x] = ' ';
                        } else if (char === '.') {
                            this.targets.push({ x, y });
                            this.map[y][x] = ' ';
                        } else if (char === '*') {
                            this.boxes.push({ x, y, onTarget: true });
                            this.targets.push({ x, y });
                            this.map[y][x] = ' ';
                        } else if (char === '+') {
                            this.playerPos = { x, y };
                            this.targets.push({ x, y });
                            this.map[y][x] = ' ';
                        } else {
                            this.map[y][x] = char;
                        }
                    }
                }

                // æ›´æ–°UI
                document.getElementById('level-display').textContent = levelIndex + 1;
                document.getElementById('moves-display').textContent = 0;

                const best = localStorage.getItem(`sokoban_best_${levelIndex}`);
                document.getElementById('best-display').textContent = best || '-';

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.level-btn').forEach((btn, i) => {
                    btn.classList.toggle('active', i === levelIndex);
                });

                this.render();
            },

            move(dx, dy) {
                const newX = this.playerPos.x + dx;
                const newY = this.playerPos.y + dy;

                // æ£€æŸ¥è¾¹ç•Œ
                if (newY < 0 || newY >= this.map.length || newX < 0 || newX >= this.map[newY].length) {
                    return;
                }

                // æ£€æŸ¥å¢™å£
                if (this.map[newY][newX] === '#') {
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰ç®±å­
                const boxIndex = this.boxes.findIndex(b => b.x === newX && b.y === newY);

                if (boxIndex !== -1) {
                    // æœ‰ç®±å­ï¼Œæ£€æŸ¥èƒ½å¦æ¨åŠ¨
                    const boxNewX = newX + dx;
                    const boxNewY = newY + dy;

                    // æ£€æŸ¥ç®±å­æ–°ä½ç½®
                    if (boxNewY < 0 || boxNewY >= this.map.length || boxNewX < 0 || boxNewX >= this.map[boxNewY].length) {
                        return;
                    }

                    if (this.map[boxNewY][boxNewX] === '#') {
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦å¦ä¸€ä¸ªç®±å­
                    if (this.boxes.some(b => b.x === boxNewX && b.y === boxNewY)) {
                        return;
                    }

                    // å¯ä»¥æ¨åŠ¨
                    this.saveHistory();

                    this.boxes[boxIndex].x = boxNewX;
                    this.boxes[boxIndex].y = boxNewY;

                    // æ£€æŸ¥ç®±å­æ˜¯å¦åœ¨ç›®æ ‡ä¸Š
                    this.boxes[boxIndex].onTarget = this.targets.some(t => t.x === boxNewX && t.y === boxNewY);

                    AudioEngine.playPush();
                } else {
                    // æ²¡æœ‰ç®±å­ï¼Œç›´æ¥ç§»åŠ¨
                    this.saveHistory();
                    AudioEngine.playMove();
                }

                // ç§»åŠ¨ç©å®¶
                this.playerPos = { x: newX, y: newY };
                this.moves++;

                document.getElementById('moves-display').textContent = this.moves;

                this.render();

                // æ£€æŸ¥æ˜¯å¦èƒœåˆ©
                this.checkWin();
            },

            saveHistory() {
                this.history.push({
                    playerPos: { ...this.playerPos },
                    boxes: this.boxes.map(b => ({ ...b })),
                    moves: this.moves
                });

                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (this.history.length > 50) {
                    this.history.shift();
                }
            },

            undo() {
                if (this.history.length === 0) return;

                const lastState = this.history.pop();
                this.playerPos = lastState.playerPos;
                this.boxes = lastState.boxes;
                this.moves = lastState.moves;

                document.getElementById('moves-display').textContent = this.moves;
                this.render();
            },

            reset() {
                this.loadLevel(this.currentLevel);
            },

            checkWin() {
                const allOnTarget = this.boxes.every(box => box.onTarget);

                if (allOnTarget) {
                    // ä¿å­˜è¿›åº¦
                    if (!this.completedLevels.includes(this.currentLevel)) {
                        this.completedLevels.push(this.currentLevel);
                        this.saveProgress();
                        this.createLevelButtons();
                    }

                    // ä¿å­˜æœ€ä½³è®°å½•
                    const best = localStorage.getItem(`sokoban_best_${this.currentLevel}`);
                    if (!best || this.moves < parseInt(best)) {
                        localStorage.setItem(`sokoban_best_${this.currentLevel}`, this.moves);
                        document.getElementById('best-display').textContent = this.moves;
                    }

                    // è®¡ç®—æ˜Ÿæ˜Ÿ
                    const levelBest = LEVELS[this.currentLevel].best;
                    let stars = 1;
                    if (this.moves <= levelBest * 1.2) stars = 3;
                    else if (this.moves <= levelBest * 1.5) stars = 2;

                    // æ˜¾ç¤ºå¥–åŠ±
                    setTimeout(() => {
                        AudioEngine.playWin();
                        this.showReward(stars);
                    }, 300);
                }
            },

            showReward(stars) {
                document.getElementById('final-moves').textContent = this.moves;

                const best = localStorage.getItem(`sokoban_best_${this.currentLevel}`);
                document.getElementById('final-best').textContent = best || '-';

                document.getElementById('reward-stars').textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(3 - stars);
                document.getElementById('reward-overlay').style.display = 'flex';

                // ä¸‹ä¸€å…³æŒ‰é’®
                const nextBtn = document.getElementById('next-btn');
                if (this.currentLevel >= LEVELS.length - 1) {
                    nextBtn.textContent = 'ğŸŠ å…¨éƒ¨é€šå…³ï¼';
                    nextBtn.onclick = () => {
                        document.getElementById('reward-overlay').style.display = 'none';
                    };
                } else {
                    nextBtn.textContent = 'ä¸‹ä¸€å…³ â¡ï¸';
                    nextBtn.onclick = () => this.nextLevel();
                }
            },

            nextLevel() {
                document.getElementById('reward-overlay').style.display = 'none';
                if (this.currentLevel < LEVELS.length - 1) {
                    this.loadLevel(this.currentLevel + 1);
                }
            },

            showHint() {
                document.getElementById('hint-box').style.display = 'block';
            },

            closeHint() {
                document.getElementById('hint-box').style.display = 'none';
            },

            createStars() {
                const container = document.getElementById('stars-container');
                for (let i = 0; i < 60; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    const size = Math.random() * 3 + 1;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    container.appendChild(star);
                }
            },

            render() {
                const canvas = document.getElementById('game-canvas');
                const ctx = canvas.getContext('2d');
                const mapHeight = this.map.length;
                const mapWidth = Math.max(...this.map.map(row => row.length));

                // è°ƒæ•´ç”»å¸ƒå¤§å°
                this.tileSize = Math.min(48, Math.floor(canvas.width / mapWidth));
                canvas.width = mapWidth * this.tileSize;
                canvas.height = mapHeight * this.tileSize;

                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ç»˜åˆ¶åœ°å›¾
                for (let y = 0; y < this.map.length; y++) {
                    for (let x = 0; x < this.map[y].length; x++) {
                        const char = this.map[y][x];
                        const px = x * this.tileSize;
                        const py = y * this.tileSize;

                        if (char === '#') {
                            // å¢™å£
                            ctx.fillStyle = '#34495e';
                            ctx.fillRect(px, py, this.tileSize, this.tileSize);
                            ctx.strokeStyle = '#2c3e50';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(px, py, this.tileSize, this.tileSize);
                        } else {
                            // åœ°æ¿
                            ctx.fillStyle = '#ecf0f1';
                            ctx.fillRect(px, py, this.tileSize, this.tileSize);
                            ctx.strokeStyle = '#bdc3c7';
                            ctx.lineWidth = 1;
                            ctx.strokeRect(px, py, this.tileSize, this.tileSize);
                        }
                    }
                }

                // ç»˜åˆ¶ç›®æ ‡
                this.targets.forEach(target => {
                    const px = target.x * this.tileSize + this.tileSize / 2;
                    const py = target.y * this.tileSize + this.tileSize / 2;

                    ctx.fillStyle = 'rgba(231, 76, 60, 0.3)';
                    ctx.beginPath();
                    ctx.arc(px, py, this.tileSize / 3, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = '#e74c3c';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(px, py, this.tileSize / 4, 0, Math.PI * 2);
                    ctx.stroke();

                    // X æ ‡è®°
                    ctx.strokeStyle = '#e74c3c';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(px - this.tileSize / 6, py - this.tileSize / 6);
                    ctx.lineTo(px + this.tileSize / 6, py + this.tileSize / 6);
                    ctx.moveTo(px + this.tileSize / 6, py - this.tileSize / 6);
                    ctx.lineTo(px - this.tileSize / 6, py + this.tileSize / 6);
                    ctx.stroke();
                });

                // ç»˜åˆ¶ç®±å­
                this.boxes.forEach(box => {
                    const px = box.x * this.tileSize;
                    const py = box.y * this.tileSize;

                    // ç®±å­é˜´å½±
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.fillRect(px + 3, py + 3, this.tileSize, this.tileSize);

                    // ç®±å­æœ¬ä½“
                    const gradient = ctx.createLinearGradient(px, py, px + this.tileSize, py + this.tileSize);
                    if (box.onTarget) {
                        gradient.addColorStop(0, '#2ecc71');
                        gradient.addColorStop(1, '#27ae60');
                    } else {
                        gradient.addColorStop(0, '#f39c12');
                        gradient.addColorStop(1, '#e67e22');
                    }
                    ctx.fillStyle = gradient;
                    ctx.fillRect(px + 2, py + 2, this.tileSize - 4, this.tileSize - 4);

                    // ç®±å­çº¹ç†
                    ctx.strokeStyle = box.onTarget ? '#27ae60' : '#d35400';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(px + 2, py + 2, this.tileSize - 4, this.tileSize - 4);

                    // ç®±å­ä¸Šçš„ X
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(px + this.tileSize * 0.2, py + this.tileSize * 0.2);
                    ctx.lineTo(px + this.tileSize * 0.8, py + this.tileSize * 0.8);
                    ctx.moveTo(px + this.tileSize * 0.8, py + this.tileSize * 0.2);
                    ctx.lineTo(px + this.tileSize * 0.2, py + this.tileSize * 0.8);
                    ctx.stroke();

                    // å¦‚æœåœ¨ç›®æ ‡ä¸Šï¼Œæ˜¾ç¤ºæ˜Ÿæ˜Ÿ
                    if (box.onTarget) {
                        ctx.fillStyle = '#f1c40f';
                        ctx.font = `${this.tileSize * 0.4}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('â˜…', px + this.tileSize / 2, py + this.tileSize / 2);
                    }
                });

                // ç»˜åˆ¶ç©å®¶
                const playerPx = this.playerPos.x * this.tileSize + this.tileSize / 2;
                const playerPy = this.playerPos.y * this.tileSize + this.tileSize / 2;

                // ç©å®¶é˜´å½±
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.arc(playerPx + 3, playerPy + 3, this.tileSize / 3, 0, Math.PI * 2);
                ctx.fill();

                // ç©å®¶èº«ä½“
                const playerGradient = ctx.createRadialGradient(
                    playerPx - this.tileSize / 10,
                    playerPy - this.tileSize / 10,
                    0,
                    playerPx, playerPy,
                    this.tileSize / 3
                );
                playerGradient.addColorStop(0, '#3498db');
                playerGradient.addColorStop(1, '#2980b9');
                ctx.fillStyle = playerGradient;
                ctx.beginPath();
                ctx.arc(playerPx, playerPy, this.tileSize / 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#1a5276';
                ctx.lineWidth = 2;
                ctx.stroke();

                // ç©å®¶çœ¼ç›
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(playerPx - this.tileSize / 10, playerPy - this.tileSize / 15, this.tileSize / 12, 0, Math.PI * 2);
                ctx.arc(playerPx + this.tileSize / 10, playerPy - this.tileSize / 15, this.tileSize / 12, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#2c3e50';
                ctx.beginPath();
                ctx.arc(playerPx - this.tileSize / 10, playerPy - this.tileSize / 15, this.tileSize / 20, 0, Math.PI * 2);
                ctx.arc(playerPx + this.tileSize / 10, playerPy - this.tileSize / 15, this.tileSize / 20, 0, Math.PI * 2);
                ctx.fill();

                // ç©å®¶å¾®ç¬‘
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(playerPx, playerPy + this.tileSize / 15, this.tileSize / 8, 0, Math.PI);
                ctx.stroke();
            },

            setupTouchControls() {
                // æ”¯æŒæ»‘åŠ¨
                let startX, startY;

                const canvas = document.getElementById('game-canvas');

                canvas.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                });

                canvas.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;

                    const dx = endX - startX;
                    const dy = endY - startY;

                    if (Math.abs(dx) > Math.abs(dy)) {
                        // æ°´å¹³æ»‘åŠ¨
                        if (Math.abs(dx) > 30) {
                            this.move(dx > 0 ? 1 : -1, 0);
                        }
                    } else {
                        // å‚ç›´æ»‘åŠ¨
                        if (Math.abs(dy) > 30) {
                            this.move(0, dy > 0 ? 1 : -1);
                        }
                    }
                });
            }
        };

        const game = Game;

        window.onload = () => game.init();
    </script>
</body>
</html>
