<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ§± å»ºé€ åˆ†æ•° - MJ ç§‘å­¦å®éªŒå®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #1a1a3e 0%, #2a2a5e 50%, #3a3a7e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* åŠ¨æ€æç¤ºæ¡† */
        #hint {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            pointer-events: none;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            max-width: 90vw;
            text-align: center;
        }

        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .control-btn {
            padding: 8px 16px;
            background: rgba(26, 84, 144, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(26, 84, 144, 1);
            transform: scale(1.05);
        }

        /* æ˜Ÿæ˜Ÿè®¡æ•°å™¨ */
        #star-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ç›®æ ‡åˆ†æ•°æ˜¾ç¤º */
        #target-display {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            text-align: center;
            z-index: 100;
        }

        #target-display h3 {
            color: #ffd700;
            font-size: 18px;
            margin-bottom: 10px;
        }

        #target-fraction {
            font-size: 48px;
            color: #e74c3c;
            margin: 15px 0;
        }

        #target-description {
            font-size: 14px;
            opacity: 0.8;
        }

        /* ç¢ç‰‡é€‰æ‹©å™¨ */
        #piece-selector {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .piece-btn {
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            cursor: pointer;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            position: relative;
        }

        .piece-btn:hover {
            background: rgba(26, 84, 144, 0.8);
            transform: scale(1.1);
            border-color: rgba(255, 215, 0, 0.6);
        }

        .piece-btn .fraction {
            font-size: 28px;
            font-weight: bold;
        }

        .piece-btn .count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid white;
        }

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        #progress-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        #progress-indicator h4 {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 10px;
        }

        #progress-bar {
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            border-radius: 10px;
            transition: width 0.3s;
        }

        #progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: #2ecc71;
            font-weight: bold;
        }

        /* å®Œæˆå¥–åŠ±å±‚ */
        #reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }

        #medal {
            font-size: 120px;
            animation: medal-pop 0.6s ease-out, medal-glow 2s infinite;
        }

        @keyframes medal-pop {
            0% { transform: scale(0) rotate(-180deg); }
            80% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes medal-glow {
            0%, 100% { filter: drop-shadow(0 0 10px #ffd700); }
            50% { filter: drop-shadow(0 0 30px #ffd700); }
        }

        #reward-text {
            color: #ffd700;
            font-size: 36px;
            margin-top: 20px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        #reward-stats {
            color: #fff;
            font-size: 18px;
            margin-top: 15px;
            text-align: center;
        }

        #next-btn {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
        }

        #next-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.7);
        }

        /* åŠ è½½åŠ¨ç”» */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a3e;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 300;
        }

        #loading .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #loading p {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <p>ğŸ§± æ­£åœ¨å‡†å¤‡åˆ†æ•°å»ºé€ å®éªŒ...</p>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <!-- æ˜Ÿæ˜Ÿè®¡æ•°å™¨ -->
        <div id="star-counter">â­ <span id="starCount">0</span></div>

        <!-- åŠ¨æ€æç¤º -->
        <div id="hint">ğŸŒŸ æŠŠä¸‹é¢çš„åˆ†æ•°ç¢ç‰‡æ‹¼èµ·æ¥ï¼Œæ‹¼å‡ºç›®æ ‡åˆ†æ•°ï¼</div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="control-btn" onclick="game.resetLevel()">ğŸ”„ é‡ç½®</button>
            <button class="control-btn" onclick="game.showHint()">ğŸ’¡ æç¤º</button>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="game-canvas"></canvas>

        <!-- ç›®æ ‡åˆ†æ•°æ˜¾ç¤º -->
        <div id="target-display">
            <h3>ğŸ¯ ç›®æ ‡åˆ†æ•°</h3>
            <div id="target-fraction">1/2</div>
            <div id="target-description">éœ€è¦ä»ä¸‹é¢çš„ç¢ç‰‡ä¸­é€‰å‡ºæ­£ç¡®çš„éƒ¨åˆ†ï¼</div>
        </div>

        <!-- ç¢ç‰‡é€‰æ‹©å™¨ -->
        <div id="piece-selector">
            <div class="piece-btn" id="piece-1" onclick="game.selectPiece(1)">
                <div class="fraction">1/4</div>
                <div class="count" id="count-1">âˆ</div>
            </div>
            <div class="piece-btn" id="piece-2" onclick="game.selectPiece(2)">
                <div class="fraction">1/4</div>
                <div class="count" id="count-2">âˆ</div>
            </div>
            <div class="piece-btn" id="piece-3" onclick="game.selectPiece(3)">
                <div class="fraction">1/2</div>
                <div class="count" id="count-3">1</div>
            </div>
        </div>

        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div id="progress-indicator">
            <h4>ğŸ“Š å®Œæˆè¿›åº¦</h4>
            <div id="progress-bar">
                <div id="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progress-text">0%</div>
        </div>
    </div>

    <!-- å®Œæˆå¥–åŠ±å±‚ -->
    <div id="reward-overlay">
        <div id="medal">ğŸ…</div>
        <div id="reward-text">åˆ†æ•°å»ºé€ å¤§å¸ˆ</div>
        <div id="reward-stats">
            å®Œæˆå…³å¡: <span id="completedLevel">1</span><br>
            æ€»æ˜Ÿæ˜Ÿ: <span id="totalStars">0</span>
        </div>
        <button id="next-btn" onclick="game.nextLevel()">ä¸‹ä¸€å…³ â¡ï¸</button>
    </div>

    <!-- åŠ è½½å¤±è´¥æç¤º -->
    <div id="loading-error" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 1000;">
        <h2>âŒ åŠ è½½å¤±è´¥</h2>
        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; font-size: 16px; border: none; border-radius: 20px; cursor: pointer; background: white; color: #e74c3c;">åˆ·æ–°é¡µé¢</button>
    </div>

    <script>
        // è¶…æ—¶æ£€æµ‹
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                loadingEl.style.display = 'none';
                document.getElementById('loading-error').style.display = 'block';
                console.error('åŠ è½½è¶…æ—¶');
            }
        }, 10000);
    </script>

    <script>
        // ==================== å…³å¡æ•°æ® ====================

        const LEVELS = [
            // å…³å¡ 1 - ç®€å•ï¼ˆ1/2 = 1/4 + 1/4ï¼‰
            {
                target: { num: 1, den: 2 },
                pieces: [
                    { num: 1, den: 4, count: 2 },
                    { num: 1, den: 4, count: 2 },
                    { num: 1, den: 2, count: 1 }
                ],
                hint: 'ğŸ’¡ 1/2 = 1/4 + 1/4ï¼Œä¸¤ä¸ªå››åˆ†ä¹‹ä¸€ç­‰äºä¸€ä¸ªäºŒåˆ†ä¹‹ä¸€ï¼'
            },
            // å…³å¡ 2ï¼ˆ1/3 = 1/6 + 1/6 + 1/6ï¼‰
            {
                target: { num: 1, den: 3 },
                pieces: [
                    { num: 1, den: 6, count: 3 },
                    { num: 1, den: 6, count: 3 },
                    { num: 1, den: 3, count: 1 }
                ],
                hint: 'ğŸ’¡ 1/3 = 1/6 + 1/6 + 1/6ï¼Œä¸‰ä¸ªå…­åˆ†ä¹‹ä¸€ç­‰äºä¸€ä¸ªä¸‰åˆ†ä¹‹ä¸€ï¼'
            },
            // å…³å¡ 3ï¼ˆ3/4 = 1/2 + 1/4ï¼‰
            {
                target: { num: 3, den: 4 },
                pieces: [
                    { num: 1, den: 2, count: 1 },
                    { num: 1, den: 4, count: 1 },
                    { num: 1, den: 4, count: 1 },
                    { num: 1, den: 8, count: 2 }
                ],
                hint: 'ğŸ’¡ 3/4 = 1/2 + 1/4ï¼Œå¯ä»¥å…ˆç”¨ 1/2 + 1/4 è¯•ä¸€è¯•ï¼'
            },
            // å…³å¡ 4ï¼ˆ2/3 = 1/3 + 1/3ï¼‰
            {
                target: { num: 2, den: 3 },
                pieces: [
                    { num: 1, den: 3, count: 2 },
                    { num: 1, den: 3, count: 2 },
                    { num: 1, den: 6, count: 4 }
                ],
                hint: 'ğŸ’¡ 2/3 = 1/3 + 1/3ï¼Œä¸¤ä¸ªä¸‰åˆ†ä¹‹ä¸€ç­‰äºä¸‰åˆ†ä¹‹äºŒï¼'
            },
            // å…³å¡ 5ï¼ˆ5/6 = 1/2 + 1/3ï¼‰
            {
                target: { num: 5, den: 6 },
                pieces: [
                    { num: 1, den: 2, count: 1 },
                    { num: 1, den: 3, count: 1 },
                    { num: 1, den: 6, count: 2 },
                    { num: 1, den: 6, count: 2 }
                ],
                hint: 'ğŸ’¡ 5/6 = 1/2 + 1/3ï¼Œå…ˆæƒ³æƒ³ 1/2 = 3/6ï¼Œ1/3 = 2/6ï¼ŒåŠ èµ·æ¥å°±æ˜¯ 5/6ï¼'
            }
        ];

        // ==================== æ¸¸æˆçŠ¶æ€ ====================

        const GameState = {
            currentLevel: 0,
            targetFraction: { num: 1, den: 2 },
            currentSum: { num: 0, den: 1 },
            selectedPieces: [],
            completedLevels: [],
            currentStars: 0,
            totalStars: 0,

            // ç”»å¸ƒ
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,

            // ç¢ç‰‡
            pieces: [],

            // æ”¾ç½®åŒºåŸŸ
            playArea: {
                x: 0,
                y: 0,
                width: 0,
                height: 0
            }
        };

        // ==================== éŸ³æ•ˆå¼•æ“ ====================

        const AudioEngine = {
            audioContext: null,

            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },

            playSelect() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 400;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.15);
            },

            playCorrect() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [523, 659, 784].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 100);
                });
            },

            playWrong() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 200;
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.08);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.3);
            },

            playComplete() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [523, 659, 784, 1047].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 120);
                });
            }
        };

        // ==================== æ ¸å¿ƒæ¸¸æˆç±» ====================

        const Game = {
            init() {
                GameState.canvas = document.getElementById('game-canvas');
                GameState.ctx = GameState.canvas.getContext('2d');

                // åŠ è½½è¿›åº¦
                this.loadProgress();

                // ç»‘å®šéŸ³é¢‘åˆå§‹åŒ–
                document.addEventListener('click', () => {
                    if (!AudioEngine.audioContext) {
                        AudioEngine.init();
                    }
                }, { once: true });

                // å“åº”çª—å£
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // åˆ›å»ºæ˜Ÿæ˜Ÿ
                this.createStars();

                // åŠ è½½æ€»æ˜Ÿæ•°
                this.loadStars();

                // åŠ è½½ç¬¬ä¸€ä¸ªå…³å¡
                this.loadLevel(0);

                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loadingEl = document.getElementById('loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                }, 800);

                // å¼€å§‹æ¸²æŸ“
                this.startRenderLoop();
            },

            resizeCanvas() {
                const canvas = GameState.canvas;
                GameState.width = window.innerWidth;
                GameState.height = window.innerHeight;

                canvas.width = GameState.width;
                canvas.height = GameState.height;

                // æ”¾ç½®åŒºåŸŸ
                GameState.playArea = {
                    x: GameState.width * 0.2,
                    y: GameState.height * 0.35,
                    width: GameState.width * 0.6,
                    height: GameState.height * 0.25
                };
            },

            loadLevel(levelIndex) {
                GameState.currentLevel = levelIndex;
                GameState.selectedPieces = [];
                GameState.currentSum = { num: 0, den: 1 };

                const levelData = LEVELS[levelIndex];
                GameState.targetFraction = levelData.target;

                // åˆ›å»ºç¢ç‰‡
                GameState.pieces = levelData.pieces.map((piece, index) => ({
                    ...piece,
                    id: index + 1,
                    used: 0,
                    x: 0,
                    y: 0,
                    targetX: 0,
                    targetY: 0
                }));

                // æ›´æ–°ç›®æ ‡æ˜¾ç¤º
                this.updateTargetDisplay();
                this.updatePieceButtons();
                this.updateProgress();

                // æ›´æ–°æç¤º
                document.getElementById('hint').textContent = levelData.hint || 'ğŸŒŸ æŠŠä¸‹é¢çš„åˆ†æ•°ç¢ç‰‡æ‹¼èµ·æ¥ï¼Œæ‹¼å‡ºç›®æ ‡åˆ†æ•°ï¼';
            },

            selectPiece(pieceId) {
                const piece = GameState.pieces.find(p => p.id === pieceId);

                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¯ç”¨ç¢ç‰‡
                if (piece.used >= piece.count) {
                    AudioEngine.playWrong();
                    return;
                }

                // æ·»åŠ åˆ°é€‰ä¸­çš„ç¢ç‰‡
                GameState.selectedPieces.push(piece);
                piece.used++;

                // è®¡ç®—å½“å‰æ€»å’Œ
                this.calculateSum();

                // æ›´æ–°æ˜¾ç¤º
                this.updatePieceButtons();
                this.updateProgress();

                AudioEngine.playSelect();

                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                this.checkCompletion();
            },

            calculateSum() {
                const sumNum = GameState.selectedPieces.reduce((total, piece) => {
                    return total + piece.num * (GameState.currentSum.den / piece.den);
                }, 0);

                // ç®€åŒ–åˆ†æ•°
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const divisor = Math.abs(gcd(sumNum, GameState.currentSum.den));

                GameState.currentSum = {
                    num: sumNum / divisor,
                    den: GameState.currentSum.den / divisor
                };
            },

            checkCompletion() {
                const target = GameState.targetFraction;
                const current = GameState.currentSum;

                // æ£€æŸ¥æ˜¯å¦ç›¸ç­‰
                const targetValue = target.num / target.den;
                const currentValue = current.num / current.den;

                if (Math.abs(targetValue - currentValue) < 0.001) {
                    // æˆåŠŸï¼
                    GameState.completedLevels.push(GameState.currentLevel);
                    GameState.currentStars++;
                    GameState.totalStars++;

                    localStorage.setItem('build_fraction_completed', JSON.stringify(GameState.completedLevels));
                    localStorage.setItem('totalStars', GameState.totalStars.toString());

                    AudioEngine.playCorrect();

                    setTimeout(() => {
                        this.showReward();
                    }, 500);
                } else if (currentValue > targetValue) {
                    // è¶…è¿‡äº†ï¼Œé‡ç½®
                    AudioEngine.playWrong();
                    this.resetPieces();
                }
            },

            resetPieces() {
                // é‡ç½®æ‰€æœ‰ç¢ç‰‡çš„ä½¿ç”¨æ¬¡æ•°
                GameState.pieces.forEach(piece => {
                    piece.used = 0;
                });

                GameState.selectedPieces = [];
                GameState.currentSum = { num: 0, den: 1 };

                this.updatePieceButtons();
                this.updateProgress();
            },

            resetLevel() {
                this.resetPieces();
                AudioEngine.playSelect();
            },

            updateTargetDisplay() {
                const target = GameState.targetFraction;
                document.getElementById('target-fraction').textContent = `${target.num}/${target.den}`;
            },

            updatePieceButtons() {
                GameState.pieces.forEach(piece => {
                    const btn = document.getElementById(`piece-${piece.id}`);
                    const countEl = document.getElementById(`count-${piece.id}`);

                    if (piece.used >= piece.count) {
                        btn.style.opacity = '0.3';
                        btn.style.pointerEvents = 'none';
                        countEl.textContent = 'âœ“';
                    } else {
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                        countEl.textContent = piece.used > 0 ? `${piece.used}/${piece.count}` : 'âˆ';
                    }
                });
            },

            updateProgress() {
                const target = GameState.targetFraction;
                const current = GameState.currentSum;

                const targetValue = target.num / target.den;
                const currentValue = current.num / current.den;

                const progress = Math.min(100, (currentValue / targetValue) * 100);
                document.getElementById('progress-fill').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;
            },

            showReward() {
                document.getElementById('completedLevel').textContent = GameState.currentLevel + 1;
                document.getElementById('totalStars').textContent = GameState.totalStars;

                const nextBtn = document.getElementById('next-btn');
                if (GameState.currentLevel >= LEVELS.length - 1) {
                    nextBtn.textContent = 'ğŸŠ å…¨éƒ¨é€šå…³ï¼';
                    nextBtn.onclick = () => {
                        document.getElementById('reward-overlay').style.display = 'none';
                    };
                } else {
                    nextBtn.textContent = 'ä¸‹ä¸€å…³ â¡ï¸';
                    nextBtn.onclick = () => this.nextLevel();
                }

                document.getElementById('reward-overlay').style.display = 'flex';
            },

            nextLevel() {
                document.getElementById('reward-overlay').style.display = 'none';
                if (GameState.currentLevel < LEVELS.length - 1) {
                    this.loadLevel(GameState.currentLevel + 1);
                }
            },

            showHint() {
                const levelData = LEVELS[GameState.currentLevel];
                alert('ğŸ’¡ å»ºé€ åˆ†æ•°æç¤ºï¼š\n\n' + levelData.hint + '\n\nğŸ’¡ å°æŠ€å·§ï¼š\n1. åˆ†æ•°åŠ æ³•ï¼ša/b + c/d = (aÃ—d + cÃ—b) / (bÃ—d)\n2. è¯•è¯•å…ˆç”¨å¤§çš„ç¢ç‰‡ï¼Œå†ç”¨å°çš„è¡¥å……\n3. å¦‚æœåŠ å¤šäº†ï¼Œå¯ä»¥é‡ç½®å†è¯•ä¸€æ¬¡ï¼');
            },

            loadProgress() {
                const saved = localStorage.getItem('build_fraction_completed');
                if (saved) {
                    GameState.completedLevels = JSON.parse(saved);
                } else {
                    GameState.completedLevels = [];
                }
            },

            loadStars() {
                const totalStars = localStorage.getItem('totalStars') || '0';
                GameState.totalStars = parseInt(totalStars);
                document.getElementById('totalStars').textContent = totalStars;
            },

            createStars() {
                const container = document.getElementById('game-container');
                for (let i = 0; i < 60; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 70 + '%';
                    const size = Math.random() * 3 + 1;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    container.appendChild(star);
                }
            },

            startRenderLoop() {
                const render = () => {
                    this.render();
                    requestAnimationFrame(render);
                };
                render();
            },

            render() {
                const ctx = GameState.ctx;
                const width = GameState.width;
                const height = GameState.height;

                ctx.clearRect(0, 0, width, height);

                this.drawBackground(ctx, width, height);
                this.drawPlayArea(ctx);
                this.drawSelectedPieces(ctx);
            },

            drawBackground(ctx, width, height) {
                // è‰åœ°
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, height * 0.85, width, height * 0.15);

                // å¤©ç©º
                const skyGradient = ctx.createLinearGradient(0, 0, 0, height * 0.85);
                skyGradient.addColorStop(0, '#87CEEB');
                skyGradient.addColorStop(1, '#E0F7FA');
                ctx.fillStyle = skyGradient;
                ctx.fillRect(0, 0, width, height * 0.85);

                // å¤ªé˜³
                ctx.beginPath();
                ctx.arc(width * 0.85, 100, 50, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700';
                ctx.fill();

                // å¤ªé˜³å…‰èŠ’
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                for (let i = 0; i < 12; i++) {
                    const angle = (i * 30) * Math.PI / 180;
                    ctx.beginPath();
                    ctx.moveTo(width * 0.85 + 60 * Math.cos(angle), 100 + 60 * Math.sin(angle));
                    ctx.lineTo(width * 0.85 + 80 * Math.cos(angle), 100 + 80 * Math.sin(angle));
                    ctx.stroke();
                }
            },

            drawPlayArea(ctx) {
                const area = GameState.playArea;

                // åŒºåŸŸèƒŒæ™¯
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.beginPath();
                ctx.roundRect(area.x, area.y, area.width, area.height, 20);
                ctx.fill();

                ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                ctx.lineWidth = 3;
                ctx.stroke();
            },

            drawSelectedPieces(ctx) {
                const area = GameState.playArea;
                const pieceCount = GameState.selectedPieces.length;

                if (pieceCount === 0) {
                    // æ˜¾ç¤ºæç¤ºæ–‡å­—
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸ‘‡ ç‚¹å‡»ä¸‹é¢çš„åˆ†æ•°ç¢ç‰‡', area.x + area.width / 2, area.y + area.height / 2);
                    return;
                }

                // è®¡ç®—ç¢ç‰‡ä½ç½®
                const pieceWidth = area.width / Math.max(pieceCount, 3);
                const gap = 10;
                const totalWidth = pieceCount * pieceWidth + (pieceCount - 1) * gap;
                const startX = area.x + (area.width - totalWidth) / 2;
                const centerY = area.y + area.height / 2;

                GameState.selectedPieces.forEach((piece, index) => {
                    const x = startX + index * (pieceWidth + gap);
                    const y = centerY;

                    // ç»˜åˆ¶ç¢ç‰‡
                    this.drawPiece(ctx, piece, x, y, pieceWidth);
                });

                // æ˜¾ç¤ºå½“å‰æ€»å’Œ
                if (pieceCount > 0) {
                    ctx.fillStyle = '#ffd700';
                    ctx.font = 'bold 32px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`= ${GameState.currentSum.num}/${GameState.currentSum.den}`, area.x + area.width / 2, area.y + area.height - 40);
                }
            },

            drawPiece(ctx, piece, x, y, width) {
                const height = width;

                // èƒŒæ™¯å¡ç‰‡
                const gradient = ctx.createLinearGradient(x, y, x + width, y + height);
                gradient.addColorStop(0, '#3498db');
                gradient.addColorStop(1, '#2980b9');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x - width/2, y - height/2, width, height, 15);
                ctx.fill();

                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();

                // åˆ†æ•°çº¿
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x - width/3, y);
                ctx.lineTo(x + width/3, y);
                ctx.stroke();

                // åˆ†å­
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(piece.num, x, y - height/4);

                // åˆ†æ¯
                ctx.fillText(piece.den, x, y + height/4);
            }
        };

        const game = Game;

        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            try {
                game.init();
                console.log('æ¸¸æˆåˆå§‹åŒ–æˆåŠŸï¼');
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                document.getElementById('loading-error').style.display = 'block';
            }
        });
    </script>
</body>
</html>
