<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸŒŠ ç‰©è´¨çŠ¶æ€åŸºç¡€ - MJ ç§‘å­¦å®éªŒå®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #1a1a3e 0%, #2a2a5e 50%, #3a3a7e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* åŠ¨æ€æç¤ºæ¡† */
        #hint {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            pointer-events: none;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            max-width: 90vw;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .control-btn {
            padding: 8px 16px;
            background: rgba(26, 84, 144, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(26, 84, 144, 1);
            transform: scale(1.05);
        }

        /* ç‰©è´¨é€‰æ‹©å™¨ */
        #substance-selector {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .substance-btn {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .substance-btn:hover {
            background: rgba(26, 84, 144, 0.8);
            transform: scale(1.05);
        }

        .substance-btn.active {
            background: rgba(155, 89, 182, 0.9);
            border-color: rgba(255, 215, 0, 0.8);
        }

        /* è§†è§’åˆ‡æ¢ */
        #view-switch {
            position: fixed;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .view-btn {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: rgba(26, 84, 144, 0.8);
            transform: scale(1.05);
        }

        .view-btn.active {
            background: rgba(155, 89, 182, 0.9);
            border-color: rgba(255, 215, 0, 0.8);
        }

        /* æ˜Ÿæ˜Ÿè®¡æ•°å™¨ */
        #star-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ¸©åº¦æ§åˆ¶é¢æ¿ */
        #temperature-control {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 40px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
            text-align: center;
            min-width: 400px;
        }

        #temperature-control h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .temp-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .temp-value {
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            min-width: 140px;
            text-align: center;
        }

        .temp-slider-container {
            width: 100%;
        }

        #temp-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #3498db 0%, #3498db 33%, #27ae60 33%, #27ae60 66%, #e74c3c 66%, #e74c3c 100%);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        #temp-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #temp-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #ffd700;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .temp-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        #state-indicator {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            min-width: 200px;
            text-align: center;
        }

        /* ä¿¡æ¯é¢æ¿ */
        #info-panel {
            position: fixed;
            top: 160px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 280px;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        #info-panel h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 16px;
        }

        #info-panel p {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.6;
            opacity: 0.9;
        }

        #info-panel .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
        }

        #info-panel .info-label {
            opacity: 0.7;
        }

        #info-panel .info-value {
            color: #ffd700;
            font-weight: bold;
        }

        /* å®Œæˆå¥–åŠ±å±‚ */
        #reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }

        #medal {
            font-size: 120px;
            animation: medal-pop 0.6s ease-out, medal-glow 2s infinite;
        }

        @keyframes medal-pop {
            0% { transform: scale(0) rotate(-180deg); }
            80% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes medal-glow {
            0%, 100% { filter: drop-shadow(0 0 10px #ffd700); }
            50% { filter: drop-shadow(0 0 30px #ffd700); }
        }

        #reward-text {
            color: #ffd700;
            font-size: 36px;
            margin-top: 20px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: text-fade 1s ease-out 0.3s both;
        }

        @keyframes text-fade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #reward-stats {
            color: #fff;
            font-size: 18px;
            margin-top: 15px;
            text-align: center;
            animation: text-fade 1s ease-out 0.6s both;
        }

        #restart-btn {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
            animation: text-fade 1s ease-out 0.9s both;
        }

        #restart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.7);
        }

        /* åŠ è½½åŠ¨ç”» */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a3e;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 300;
        }

        #loading .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #loading p {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <p>ğŸŒŠ æ­£åœ¨å‡†å¤‡ç‰©è´¨çŠ¶æ€å®éªŒ...</p>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <!-- æ˜Ÿæ˜Ÿè®¡æ•°å™¨ -->
        <div id="star-counter">â­ <span id="starCount">0</span></div>

        <!-- åŠ¨æ€æç¤º -->
        <div id="hint">ğŸŒŸ é€‰æ‹©ä¸€ç§ç‰©è´¨ï¼Œç„¶åè°ƒèŠ‚æ¸©åº¦è§‚å¯ŸçŠ¶æ€å˜åŒ–ï¼</div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="control-btn" onclick="game.reset()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="control-btn" onclick="game.showHint()">ğŸ’¡ æ˜¾ç¤ºæç¤º</button>
        </div>

        <!-- ç‰©è´¨é€‰æ‹©å™¨ -->
        <div id="substance-selector">
            <button class="substance-btn active" id="btn-water" onclick="game.selectSubstance('water')">ğŸ’§ æ°´</button>
            <button class="substance-btn" id="btn-neon" onclick="game.selectSubstance('neon')">ğŸŒˆ æ°–</button>
            <button class="substance-btn" id="btn-oxygen" onclick="game.selectSubstance('oxygen')">ğŸ’¨ æ°§</button>
        </div>

        <!-- è§†è§’åˆ‡æ¢ -->
        <div id="view-switch">
            <button class="view-btn active" id="btn-macro" onclick="game.switchView('macro')">ğŸ” å®è§‚</button>
            <button class="view-btn" id="btn-micro" onclick="game.switchView('micro')">ğŸ”¬ å¾®è§‚</button>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="game-canvas"></canvas>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="state-indicator">â„ï¸ å›ºæ€</div>

        <!-- æ¸©åº¦æ§åˆ¶ -->
        <div id="temperature-control">
            <h3>ğŸŒ¡ï¸ æ¸©åº¦æ§åˆ¶</h3>
            <div class="temp-display">
                <span class="temp-value" id="temp-value">0Â°C</span>
            </div>
            <div class="temp-slider-container">
                <input type="range" id="temp-slider" min="-200" max="200" value="0" oninput="game.updateTemperature()">
            </div>
            <div class="temp-labels">
                <span>-200Â°C</span>
                <span>0Â°C</span>
                <span>100Â°C</span>
                <span>200Â°C</span>
            </div>
        </div>

        <!-- ä¿¡æ¯é¢æ¿ -->
        <div id="info-panel">
            <h3 id="info-title">ğŸ’§ æ°´</h3>
            <p id="info-description">æœ€å¸¸è§çš„ç‰©è´¨ï¼Œå­˜åœ¨äºæˆ‘ä»¬ç”Ÿæ´»ä¸­çš„æ¯ä¸€å¤©ã€‚</p>
            <div class="info-row">
                <span class="info-label">ç†”ç‚¹:</span>
                <span class="info-value" id="info-melting">0Â°C</span>
            </div>
            <div class="info-row">
                <span class="info-label">æ²¸ç‚¹:</span>
                <span class="info-value" id="info-boiling">100Â°C</span>
            </div>
            <div class="info-row">
                <span class="info-label">å½“å‰çŠ¶æ€:</span>
                <span class="info-value" id="info-state">æ¶²æ€</span>
            </div>
            <div class="info-row">
                <span class="info-label">åˆ†å­é€Ÿåº¦:</span>
                <span class="info-value" id="info-speed">ä¸­ç­‰</span>
            </div>
        </div>
    </div>

    <!-- å®Œæˆå¥–åŠ±å±‚ -->
    <div id="reward-overlay">
        <div id="medal">ğŸ…</div>
        <div id="reward-text">ç‰©è´¨çŠ¶æ€å¤§å¸ˆ</div>
        <div id="reward-stats">
            æ¢ç´¢æ¬¡æ•°: <span id="exploreCount">0</span><br>
            æ€»æ˜Ÿæ˜Ÿ: <span id="totalStars">0</span>
        </div>
        <button id="restart-btn" onclick="game.restart()">ç»§ç»­æ¢ç´¢</button>
    </div>

    <!-- åŠ è½½å¤±è´¥æç¤º -->
    <div id="loading-error" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 1000;">
        <h2>âŒ åŠ è½½å¤±è´¥</h2>
        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; font-size: 16px; border: none; border-radius: 20px; cursor: pointer; background: white; color: #e74c3c;">åˆ·æ–°é¡µé¢</button>
    </div>

    <script>
        // è¶…æ—¶æ£€æµ‹
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                loadingEl.style.display = 'none';
                document.getElementById('loading-error').style.display = 'block';
                console.error('åŠ è½½è¶…æ—¶');
            }
        }, 10000);
    </script>

    <script>
        // ==================== ç‰©è´¨æ•°æ® ====================

        const SUBSTANCE_DATA = {
            water: {
                name: 'ğŸ’§ æ°´',
                description: 'æœ€å¸¸è§çš„ç‰©è´¨ï¼Œå­˜åœ¨äºæˆ‘ä»¬ç”Ÿæ´»ä¸­çš„æ¯ä¸€å¤©ã€‚',
                meltingPoint: 0,
                boilingPoint: 100,
                color: '#3498db',
                particles: [
                    { color: '#3498db', size: 8 }
                ]
            },
            neon: {
                name: 'ğŸŒˆ æ°–',
                description: 'ä¸€ç§ç¨€æœ‰æ°”ä½“ï¼Œé€šç”µåä¼šå‘å‡ºæ©˜çº¢è‰²çš„å…‰ã€‚',
                meltingPoint: -249,
                boilingPoint: -246,
                color: '#e74c3c',
                particles: [
                    { color: '#e74c3c', size: 10 }
                ]
            },
            oxygen: {
                name: 'ğŸ’¨ æ°§',
                description: 'æˆ‘ä»¬å‘¼å¸çš„æ°”ä½“ï¼Œæ”¯æŒç‡ƒçƒ§å’Œç”Ÿå‘½æ´»åŠ¨ã€‚',
                meltingPoint: -219,
                boilingPoint: -183,
                color: '#27ae60',
                particles: [
                    { color: '#27ae60', size: 9 }
                ]
            }
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================

        const GameState = {
            currentSubstance: 'water',
            currentView: 'macro', // 'macro' æˆ– 'micro'
            temperature: 0,
            state: 'liquid', // 'solid', 'liquid', 'gas'
            exploreCount: 0,
            currentStars: 0,
            totalStars: 0,

            // å¾®è§‚ç²’å­
            particles: [],

            // ç”»å¸ƒ
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,

            // å®¹å™¨
            container: {
                x: 0,
                y: 0,
                width: 0,
                height: 0
            },

            // å®è§‚å¯¹è±¡
            macroObject: {
                x: 0,
                y: 0,
                size: 0,
                phase: 0
            }
        };

        // ==================== éŸ³æ•ˆå¼•æ“ ====================

        const AudioEngine = {
            audioContext: null,

            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },

            playChange() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 400;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.3);
            },

            playPhaseChange() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [392, 523, 659].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 150);
                });
            },

            playComplete() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [523, 659, 784, 1047].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 120);
                });
            }
        };

        // ==================== æ ¸å¿ƒæ¸¸æˆç±» ====================

        const Game = {
            init() {
                GameState.canvas = document.getElementById('game-canvas');
                GameState.ctx = GameState.canvas.getContext('2d');

                // ç»‘å®šéŸ³é¢‘åˆå§‹åŒ–
                document.addEventListener('click', () => {
                    if (!AudioEngine.audioContext) {
                        AudioEngine.init();
                    }
                }, { once: true });

                // å“åº”çª—å£
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // åˆå§‹åŒ–ç²’å­
                this.initParticles();

                // åˆ›å»ºæ˜Ÿæ˜Ÿ
                this.createStars();

                // åŠ è½½æ€»æ˜Ÿæ•°
                this.loadStars();

                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loadingEl = document.getElementById('loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                }, 800);

                // å¼€å§‹æ¸²æŸ“
                this.startRenderLoop();
            },

            resizeCanvas() {
                const canvas = GameState.canvas;
                GameState.width = window.innerWidth;
                GameState.height = window.innerHeight;

                canvas.width = GameState.width;
                canvas.height = GameState.height;

                // å®¹å™¨ä½ç½®
                GameState.container.x = GameState.width * 0.5;
                GameState.container.y = GameState.height * 0.45;
                GameState.container.width = GameState.width * 0.4;
                GameState.container.height = GameState.height * 0.25;

                // å®è§‚å¯¹è±¡
                GameState.macroObject.x = GameState.width * 0.5;
                GameState.macroObject.y = GameState.height * 0.45;
                GameState.macroObject.size = GameState.width * 0.15;

                this.initParticles();
            },

            initParticles() {
                const particleCount = 50;
                const substance = SUBSTANCE_DATA[GameState.currentSubstance];
                const container = GameState.container;

                GameState.particles = [];

                for (let i = 0; i < particleCount; i++) {
                    GameState.particles.push({
                        x: container.x + (Math.random() - 0.5) * container.width * 0.8,
                        y: container.y + (Math.random() - 0.5) * container.height * 0.8,
                        vx: 0,
                        vy: 0,
                        size: substance.particles[0].size + Math.random() * 3,
                        color: substance.particles[0].color,
                        inContainer: true
                    });
                }
            },

            selectSubstance(substance) {
                GameState.currentSubstance = substance;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('btn-water').classList.toggle('active', substance === 'water');
                document.getElementById('btn-neon').classList.toggle('active', substance === 'neon');
                document.getElementById('btn-oxygen').classList.toggle('active', substance === 'oxygen');

                // æ›´æ–°ä¿¡æ¯é¢æ¿
                const data = SUBSTANCE_DATA[substance];
                document.getElementById('info-title').textContent = data.name;
                document.getElementById('info-description').textContent = data.description;
                document.getElementById('info-melting').textContent = data.meltingPoint + 'Â°C';
                document.getElementById('info-boiling').textContent = data.boilingPoint + 'Â°C';

                // é‡ç½®ç²’å­
                this.initParticles();
                this.updateTemperature();

                AudioEngine.playChange();
            },

            switchView(view) {
                GameState.currentView = view;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('btn-macro').classList.toggle('active', view === 'macro');
                document.getElementById('btn-micro').classList.toggle('active', view === 'micro');

                // æ›´æ–°æç¤º
                if (view === 'macro') {
                    document.getElementById('hint').textContent = 'ğŸ” å®è§‚è§†è§’ï¼šè§‚å¯Ÿç‰©è´¨çš„æ•´ä½“å¤–è§‚å˜åŒ–ï¼';
                } else {
                    document.getElementById('hint').textContent = 'ğŸ”¬ å¾®è§‚è§†è§’ï¼šè§‚å¯Ÿåˆ†å­çš„è¿åŠ¨å’Œæ’åˆ—æ–¹å¼ï¼';
                }

                AudioEngine.playChange();
            },

            updateTemperature() {
                const temp = parseInt(document.getElementById('temp-slider').value);
                GameState.temperature = temp;

                document.getElementById('temp-value').textContent = temp + 'Â°C';

                const substance = SUBSTANCE_DATA[GameState.currentSubstance];
                let newState, stateText, stateEmoji;

                if (temp < substance.meltingPoint) {
                    newState = 'solid';
                    stateText = 'å›ºæ€';
                    stateEmoji = 'â„ï¸';
                } else if (temp < substance.boilingPoint) {
                    newState = 'liquid';
                    stateText = 'æ¶²æ€';
                    stateEmoji = 'ğŸ’§';
                } else {
                    newState = 'gas';
                    stateText = 'æ°”æ€';
                    stateEmoji = 'ğŸ’¨';
                }

                // æ£€æŸ¥çŠ¶æ€å˜åŒ–
                if (GameState.state !== newState) {
                    GameState.state = newState;
                    document.getElementById('state-indicator').textContent = stateEmoji + ' ' + stateText;
                    document.getElementById('info-state').textContent = stateText;
                    AudioEngine.playPhaseChange();

                    // å¥–åŠ±æ£€æŸ¥
                    if (this.hasExploredAllStates()) {
                        GameState.exploreCount++;
                        GameState.currentStars++;
                        GameState.totalStars++;
                        document.getElementById('exploreCount').textContent = GameState.exploreCount;
                        document.getElementById('starCount').textContent = GameState.currentStars;
                        localStorage.setItem('totalStars', GameState.totalStars.toString());
                        document.getElementById('totalStars').textContent = GameState.totalStars;

                        setTimeout(() => {
                            AudioEngine.playComplete();
                            this.showReward();
                        }, 500);
                    }
                }

                // æ›´æ–°åˆ†å­é€Ÿåº¦ä¿¡æ¯
                const speed = this.getMoleculeSpeed();
                document.getElementById('info-speed').textContent = speed;

                AudioEngine.playChange();
            },

            getMoleculeSpeed() {
                const temp = GameState.temperature;
                if (temp < -100) return 'ææ…¢';
                if (temp < 0) return 'æ…¢';
                if (temp < 50) return 'ä¸­ç­‰';
                if (temp < 100) return 'å¿«';
                return 'æå¿«';
            },

            hasExploredAllStates() {
                const substance = SUBSTANCE_DATA[GameState.currentSubstance];
                const temp = GameState.temperature;

                const hasSolid = temp < substance.meltingPoint;
                const hasLiquid = temp >= substance.meltingPoint && temp < substance.boilingPoint;
                const hasGas = temp >= substance.boilingPoint;

                return hasSolid || hasLiquid || hasGas;
            },

            reset() {
                document.getElementById('temp-slider').value = 0;
                this.updateTemperature();
                this.initParticles();
            },

            showHint() {
                alert('ğŸ’¡ ç‰©è´¨çŠ¶æ€æç¤ºï¼š\n\n**å›ºæ€**ï¼šåˆ†å­æ’åˆ—ç´§å¯†ï¼Œåªèƒ½åœ¨å›ºå®šä½ç½®æŒ¯åŠ¨\n**æ¶²æ€**ï¼šåˆ†å­å¯ä»¥è‡ªç”±æµåŠ¨ï¼Œä½†å½¼æ­¤é å¾—å¾ˆè¿‘\n**æ°”æ€**ï¼šåˆ†å­è¿åŠ¨å¿«é€Ÿï¼Œå½¼æ­¤åˆ†ç¦»å¾ˆè¿œ\n\n**æ¸©åº¦ä¸çŠ¶æ€çš„å…³ç³»**ï¼š\n- æ¸©åº¦ä½äºç†”ç‚¹ï¼šå›ºæ€\n- æ¸©åº¦åœ¨ç†”ç‚¹å’Œæ²¸ç‚¹ä¹‹é—´ï¼šæ¶²æ€\n- æ¸©åº¦é«˜äºæ²¸ç‚¹ï¼šæ°”æ€\n\nä¸åŒçš„ç‰©è´¨æœ‰ä¸åŒçš„ç†”ç‚¹å’Œæ²¸ç‚¹ï¼');
            },

            restart() {
                document.getElementById('reward-overlay').style.display = 'none';
                this.reset();
            },

            loadStars() {
                const totalStars = localStorage.getItem('totalStars') || '0';
                GameState.totalStars = parseInt(totalStars);
                document.getElementById('totalStars').textContent = totalStars;
            },

            showReward() {
                const overlay = document.getElementById('reward-overlay');
                overlay.style.display = 'flex';
            },

            createStars() {
                const container = document.getElementById('game-container');

                for (let i = 0; i < 60; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';

                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 70 + '%';

                    const size = Math.random() * 3 + 1;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';

                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 2 + 1) + 's';

                    container.appendChild(star);
                }
            },

            startRenderLoop() {
                const render = () => {
                    this.update();
                    this.render();
                    requestAnimationFrame(render);
                };
                render();
            },

            update() {
                // æ›´æ–°ç²’å­
                GameState.particles.forEach(particle => {
                    const substance = SUBSTANCE_DATA[GameState.currentSubstance];
                    const state = GameState.state;
                    const container = GameState.container;

                    // æ ¹æ®çŠ¶æ€æ›´æ–°é€Ÿåº¦
                    if (state === 'solid') {
                        // å›ºæ€ï¼šåŸåœ°æŒ¯åŠ¨
                        const vibrationSpeed = 0.5 + (GameState.temperature - substance.meltingPoint) / 100;
                        particle.vx = (Math.random() - 0.5) * vibrationSpeed;
                        particle.vy = (Math.random() - 0.5) * vibrationSpeed;
                    } else if (state === 'liquid') {
                        // æ¶²æ€ï¼šç¼“æ…¢æµåŠ¨
                        const flowSpeed = 0.8 + (GameState.temperature - substance.meltingPoint) / 80;
                        particle.vx = (Math.random() - 0.5) * flowSpeed;
                        particle.vy = (Math.random() - 0.5) * flowSpeed;
                    } else {
                        // æ°”æ€ï¼šå¿«é€Ÿè¿åŠ¨
                        const gasSpeed = 3 + (GameState.temperature - substance.boilingPoint) / 30;
                        const angle = Math.random() * Math.PI * 2;
                        particle.vx = Math.cos(angle) * gasSpeed;
                        particle.vy = Math.sin(angle) * gasSpeed;
                    }

                    // æ›´æ–°ä½ç½®
                    particle.x += particle.vx;
                    particle.y += particle.vy;

                    // è¾¹ç•Œæ£€æŸ¥
                    if (state === 'gas') {
                        // æ°”æ€ï¼šå¯ä»¥é€ƒé€¸å®¹å™¨
                        particle.inContainer = false;
                    } else {
                        // å›ºæ€å’Œæ¶²æ€ï¼šé™åˆ¶åœ¨å®¹å™¨å†…
                        if (particle.inContainer) {
                            if (particle.x < container.x - container.width / 2 + particle.size) {
                                particle.x = container.x - container.width / 2 + particle.size;
                                particle.vx *= -0.5;
                            }
                            if (particle.x > container.x + container.width / 2 - particle.size) {
                                particle.x = container.x + container.width / 2 - particle.size;
                                particle.vx *= -0.5;
                            }
                            if (particle.y < container.y - container.height / 2 + particle.size) {
                                particle.y = container.y - container.height / 2 + particle.size;
                                particle.vy *= -0.5;
                            }
                            if (particle.y > container.y + container.height / 2 - particle.size) {
                                particle.y = container.y + container.height / 2 - particle.size;
                                particle.vy *= -0.5;
                            }
                        }
                    }

                    // å±å¹•è¾¹ç•Œï¼ˆé˜²æ­¢ç²’å­è·‘å¤ªè¿œï¼‰
                    if (particle.x < -200 || particle.x > GameState.width + 200 ||
                        particle.y < -200 || particle.y > GameState.height + 200) {
                        particle.x = container.x;
                        particle.y = container.y;
                    }
                });

                // æ›´æ–°å®è§‚å¯¹è±¡ç›¸ä½
                GameState.macroObject.phase += 0.02;
            },

            render() {
                const ctx = GameState.ctx;
                const width = GameState.width;
                const height = GameState.height;

                ctx.clearRect(0, 0, width, height);

                this.drawBackground(ctx, width, height);

                if (GameState.currentView === 'macro') {
                    this.renderMacro(ctx, width, height);
                } else {
                    this.renderMicro(ctx, width, height);
                }
            },

            drawBackground(ctx, width, height) {
                // è‰åœ°
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, height * 0.85, width, height * 0.15);

                // å¤©ç©º
                const skyGradient = ctx.createLinearGradient(0, 0, 0, height * 0.85);
                skyGradient.addColorStop(0, '#87CEEB');
                skyGradient.addColorStop(1, '#E0F7FA');
                ctx.fillStyle = skyGradient;
                ctx.fillRect(0, 0, width, height * 0.85);

                // å¤ªé˜³
                ctx.beginPath();
                ctx.arc(width * 0.85, 100, 50, 0, Math.PI * 2);
                ctx.fillStyle = '#FFD700';
                ctx.fill();

                // å¤ªé˜³å…‰èŠ’
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                for (let i = 0; i < 12; i++) {
                    const angle = (i * 30) * Math.PI / 180;
                    ctx.beginPath();
                    ctx.moveTo(width * 0.85 + 60 * Math.cos(angle), 100 + 60 * Math.sin(angle));
                    ctx.lineTo(width * 0.85 + 80 * Math.cos(angle), 100 + 80 * Math.sin(angle));
                    ctx.stroke();
                }
            },

            renderMacro(ctx, width, height) {
                const substance = SUBSTANCE_DATA[GameState.currentSubstance];
                const state = GameState.state;
                const obj = GameState.macroObject;

                // ç»˜åˆ¶å®¹å™¨
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 4;
                ctx.strokeRect(obj.x - obj.size / 2 - 10, obj.y - obj.size / 2 - 10, obj.size + 20, obj.size + 20);

                // ç»˜åˆ¶ç‰©è´¨
                ctx.save();
                ctx.translate(obj.x, obj.y);

                if (state === 'solid') {
                    // å›ºæ€ï¼šæ–¹å½¢ï¼Œå›ºå®šå½¢çŠ¶
                    ctx.fillStyle = substance.color;
                    ctx.fillRect(-obj.size / 2, -obj.size / 2, obj.size, obj.size);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(-obj.size / 2, -obj.size / 2, obj.size, obj.size);

                    // å†°è£‚çº¹
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(-obj.size / 4, -obj.size / 2);
                    ctx.lineTo(0, 0);
                    ctx.lineTo(obj.size / 4, -obj.size / 2);
                    ctx.stroke();
                } else if (state === 'liquid') {
                    // æ¶²æ€ï¼šåœ†å½¢ï¼ŒæµåŠ¨
                    const radius = obj.size / 2 * (0.9 + 0.1 * Math.sin(obj.phase));
                    ctx.beginPath();
                    ctx.arc(0, 0, radius, 0, Math.PI * 2);
                    ctx.fillStyle = substance.color;
                    ctx.fill();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 3;
                    ctx.stroke();

                    // æ°´æ³¢çº¹
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 2;
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(0, 0, radius - 10 - i * 8, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                } else {
                    // æ°”æ€ï¼šæ°”æ³¡ï¼Œé£˜é€¸
                    ctx.globalAlpha = 0.6;
                    for (let i = 0; i < 5; i++) {
                        const bubbleRadius = (obj.size / 6) * (0.8 + 0.4 * Math.sin(obj.phase + i * 0.5));
                        const bubbleX = Math.sin(obj.phase * 0.7 + i) * (obj.size / 3);
                        const bubbleY = Math.cos(obj.phase * 0.7 + i) * (obj.size / 3);

                        ctx.beginPath();
                        ctx.arc(bubbleX, bubbleY, bubbleRadius, 0, Math.PI * 2);
                        ctx.fillStyle = substance.color;
                        ctx.fill();
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                }

                ctx.restore();

                // æ ‡ç­¾
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(substance.name, obj.x, obj.y + obj.size / 2 + 40);
            },

            renderMicro(ctx, width, height) {
                const container = GameState.container;

                // ç»˜åˆ¶å®¹å™¨
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(container.x - container.width / 2, container.y - container.height / 2, container.width, container.height);

                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 4;
                ctx.strokeRect(container.x - container.width / 2, container.y - container.height / 2, container.width, container.height);

                // ç»˜åˆ¶ç²’å­
                GameState.particles.forEach(particle => {
                    ctx.save();
                    ctx.globalAlpha = 0.8;

                    // ç²’å­å…‰æ™•
                    const glow = ctx.createRadialGradient(particle.x, particle.y, 0, particle.x, particle.y, particle.size * 2);
                    glow.addColorStop(0, particle.color);
                    glow.addColorStop(1, 'rgba(0, 0, 0, 0)');
                    ctx.fillStyle = glow;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size * 2, 0, Math.PI * 2);
                    ctx.fill();

                    // ç²’å­æœ¬ä½“
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    ctx.restore();
                });

                // çŠ¶æ€è¯´æ˜
                ctx.fillStyle = 'white';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                let stateDescription = '';
                if (GameState.state === 'solid') {
                    stateDescription = 'åˆ†å­ç´§å¯†æ’åˆ—ï¼Œåªèƒ½åœ¨å›ºå®šä½ç½®æŒ¯åŠ¨';
                } else if (GameState.state === 'liquid') {
                    stateDescription = 'åˆ†å­å¯ä»¥æµåŠ¨ï¼Œä½†å½¼æ­¤é è¿‘';
                } else {
                    stateDescription = 'åˆ†å­å¿«é€Ÿè¿åŠ¨ï¼Œå½¼æ­¤åˆ†ç¦»';
                }
                ctx.fillText(stateDescription, container.x, container.y + container.height / 2 + 50);
            }
        };

        const game = Game;

        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            try {
                game.init();
                console.log('æ¸¸æˆåˆå§‹åŒ–æˆåŠŸï¼');
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                document.getElementById('loading-error').style.display = 'block';
            }
        });
    </script>
</body>
</html>
