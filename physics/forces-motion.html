<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ’ª åŠ›ä¸è¿åŠ¨ - MJ ç§‘å­¦å®éªŒå®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(to bottom, #1a1a3e 0%, #2a2a5e 50%, #3a3a7e 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
            pointer-events: none;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* åŠ¨æ€æç¤ºæ¡† */
        #hint {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            pointer-events: none;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            max-width: 90vw;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .control-btn {
            padding: 8px 16px;
            background: rgba(26, 84, 144, 0.8);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(26, 84, 144, 1);
            transform: scale(1.05);
        }

        /* åœºæ™¯åˆ‡æ¢æŒ‰é’® */
        #scene-switch {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .scene-btn {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }

        .scene-btn:hover {
            background: rgba(26, 84, 144, 0.8);
            transform: scale(1.05);
        }

        .scene-btn.active {
            background: rgba(155, 89, 182, 0.9);
            border-color: rgba(255, 215, 0, 0.8);
        }

        /* æ˜Ÿæ˜Ÿè®¡æ•°å™¨ */
        #star-counter {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 20px;
            z-index: 100;
            border: 2px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ‹”æ²³æ§åˆ¶é¢æ¿ */
        #tug-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 100;
        }

        .team-control {
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .team-control h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .control-row label {
            color: white;
            font-size: 14px;
            min-width: 60px;
        }

        .control-row input[type="range"] {
            width: 120px;
            cursor: pointer;
        }

        .control-row .value {
            color: #ffd700;
            font-weight: bold;
            min-width: 30px;
            text-align: right;
        }

        .control-row button {
            padding: 8px 16px;
            background: rgba(155, 89, 182, 0.8);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-row button:hover {
            background: rgba(155, 89, 182, 1);
            transform: scale(1.05);
        }

        /* æ¨ç®±å­æ§åˆ¶é¢æ¿ */
        #push-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
        }

        #push-controls h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
        }

        .push-control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 12px 0;
        }

        .push-control-row label {
            color: white;
            font-size: 14px;
            min-width: 80px;
        }

        .push-control-row input[type="range"] {
            width: 150px;
            cursor: pointer;
        }

        .push-control-row .value {
            color: #ffd700;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }

        .push-control-row select {
            padding: 8px 12px;
            background: rgba(155, 89, 182, 0.8);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .push-button {
            padding: 15px 40px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .push-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        /* å®Œæˆå¥–åŠ±å±‚ */
        #reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
        }

        #medal {
            font-size: 120px;
            animation: medal-pop 0.6s ease-out, medal-glow 2s infinite;
        }

        @keyframes medal-pop {
            0% { transform: scale(0) rotate(-180deg); }
            80% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes medal-glow {
            0%, 100% { filter: drop-shadow(0 0 10px #ffd700); }
            50% { filter: drop-shadow(0 0 30px #ffd700); }
        }

        #reward-text {
            color: #ffd700;
            font-size: 36px;
            margin-top: 20px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: text-fade 1s ease-out 0.3s both;
        }

        @keyframes text-fade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #reward-stats {
            color: #fff;
            font-size: 18px;
            margin-top: 15px;
            text-align: center;
            animation: text-fade 1s ease-out 0.6s both;
        }

        #restart-btn {
            margin-top: 30px;
            padding: 15px 50px;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s;
            animation: text-fade 1s ease-out 0.9s both;
        }

        #restart-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.7);
        }

        /* åŠ è½½åŠ¨ç”» */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a3e;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 300;
        }

        #loading .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #loading p {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading">
        <div class="spinner"></div>
        <p>ğŸ’ª æ­£åœ¨å‡†å¤‡åŠ›ä¸è¿åŠ¨å®éªŒ...</p>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <!-- æ˜Ÿæ˜Ÿè®¡æ•°å™¨ -->
        <div id="star-counter">â­ <span id="starCount">0</span></div>

        <!-- åŠ¨æ€æç¤º -->
        <div id="hint">ğŸŒŸ é€‰æ‹©ä¸€ä¸ªåœºæ™¯å¼€å§‹æ¢ç´¢åŠ›çš„å¥¥ç§˜ï¼</div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div id="controls">
            <button class="control-btn" onclick="game.reset()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            <button class="control-btn" onclick="game.showHint()">ğŸ’¡ æ˜¾ç¤ºæç¤º</button>
        </div>

        <!-- åœºæ™¯åˆ‡æ¢ -->
        <div id="scene-switch">
            <button class="scene-btn active" id="btn-tug" onclick="game.switchScene('tug')">ğŸ® æ‹”æ²³æ¯”èµ›</button>
            <button class="scene-btn" id="btn-push" onclick="game.switchScene('push')">ğŸ“¦ æ¨ç®±å­</button>
        </div>

        <!-- æ¸¸æˆç”»å¸ƒ -->
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- æ‹”æ²³æ§åˆ¶é¢æ¿ -->
    <div id="tug-controls">
        <div class="team-control">
            <h3>ğŸ”µ è“é˜Ÿ</h3>
            <div class="control-row">
                <label>äººæ•°:</label>
                <input type="range" id="blue-people" min="1" max="5" value="2" oninput="game.updateTugSettings()">
                <span class="value" id="blue-people-value">2</span>
            </div>
            <div class="control-row">
                <label>åŠ›é‡:</label>
                <input type="range" id="blue-force" min="50" max="200" value="100" oninput="game.updateTugSettings()">
                <span class="value" id="blue-force-value">100</span>
            </div>
        </div>
        <div class="team-control">
            <h3>ğŸ”´ çº¢é˜Ÿ</h3>
            <div class="control-row">
                <label>äººæ•°:</label>
                <input type="range" id="red-people" min="1" max="5" value="2" oninput="game.updateTugSettings()">
                <span class="value" id="red-people-value">2</span>
            </div>
            <div class="control-row">
                <label>åŠ›é‡:</label>
                <input type="range" id="red-force" min="50" max="200" value="100" oninput="game.updateTugSettings()">
                <span class="value" id="red-force-value">100</span>
            </div>
        </div>
    </div>

    <!-- æ¨ç®±å­æ§åˆ¶é¢æ¿ -->
    <div id="push-controls">
        <h3>ğŸ“¦ æ¨ç®±å­å®éªŒ</h3>
        <div class="push-control-row">
            <label>æ¨åŠ›:</label>
            <input type="range" id="push-force" min="0" max="300" value="100" oninput="game.updatePushSettings()">
            <span class="value" id="push-force-value">100 N</span>
        </div>
        <div class="push-control-row">
            <label>æ‘©æ“¦ç³»æ•°:</label>
            <input type="range" id="friction" min="0.1" max="0.9" step="0.1" value="0.3" oninput="game.updatePushSettings()">
            <span class="value" id="friction-value">0.3</span>
        </div>
        <div class="push-control-row">
            <label>è¡¨é¢:</label>
            <select id="surface-type" onchange="game.updateSurface()">
                <option value="ice">â„ï¸ å†°é¢ (Î¼=0.1)</option>
                <option value="wood" selected>ğŸªµ æœ¨æ¿ (Î¼=0.3)</option>
                <option value="sand">ğŸ–ï¸ æ²™åœ° (Î¼=0.5)</option>
                <option value="carpet">ğŸ§¶ åœ°æ¯¯ (Î¼=0.7)</option>
                <option value="rubber">ğŸ æ©¡èƒ¶ (Î¼=0.9)</option>
            </select>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="push-button" onclick="game.pushBox()">ğŸ’¨ æ¨ï¼</button>
        </div>
    </div>

    <!-- å®Œæˆå¥–åŠ±å±‚ -->
    <div id="reward-overlay">
        <div id="medal">ğŸ…</div>
        <div id="reward-text">åŠ›ä¸è¿åŠ¨å¤§å¸ˆ</div>
        <div id="reward-stats">
            å®éªŒæ¬¡æ•°: <span id="experimentCount">0</span><br>
            æ€»æ˜Ÿæ˜Ÿ: <span id="totalStars">0</span>
        </div>
        <button id="restart-btn" onclick="game.restart()">ç»§ç»­å®éªŒ</button>
    </div>

    <!-- åŠ è½½å¤±è´¥æç¤º -->
    <div id="loading-error" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(231, 76, 60, 0.9); color: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 1000;">
        <h2>âŒ åŠ è½½å¤±è´¥</h2>
        <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; font-size: 16px; border: none; border-radius: 20px; cursor: pointer; background: white; color: #e74c3c;">åˆ·æ–°é¡µé¢</button>
    </div>

    <script>
        // è¶…æ—¶æ£€æµ‹
        setTimeout(() => {
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                loadingEl.style.display = 'none';
                document.getElementById('loading-error').style.display = 'block';
                console.error('åŠ è½½è¶…æ—¶');
            }
        }, 10000);
    </script>

    <script>
        // ==================== æ¸¸æˆçŠ¶æ€ ====================

        const GameState = {
            currentScene: 'tug', // 'tug' æˆ– 'push'

            // æ‹”æ²³çŠ¶æ€
            tug: {
                blueTeam: {
                    people: 2,
                    forcePerPerson: 100,
                    totalForce: 200
                },
                redTeam: {
                    people: 2,
                    forcePerPerson: 100,
                    totalForce: 200
                },
                ropePosition: 0, // ç›¸å¯¹äºä¸­å¿ƒçš„ä½ç½®
                ropeSpeed: 0,
                won: false,
                winner: null
            },

            // æ¨ç®±å­çŠ¶æ€
            push: {
                boxPosition: 0,
                boxVelocity: 0,
                appliedForce: 100,
                frictionCoefficient: 0.3,
                surfaceName: 'æœ¨æ¿',
                boxMass: 50, // kg
                isPushing: false
            },

            // æ¸¸æˆç»Ÿè®¡
            experimentCount: 0,
            currentStars: 0,
            totalStars: 0,

            // ç”»å¸ƒ
            canvas: null,
            ctx: null,
            width: 0,
            height: 0
        };

        // ==================== éŸ³æ•ˆå¼•æ“ ====================

        const AudioEngine = {
            audioContext: null,

            init() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            },

            playTugSound() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 150;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.3);
            },

            playWinSound() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                [523, 659, 784, 1047].forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = ctx.createOscillator();
                        const gainNode = ctx.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(ctx.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0, ctx.currentTime);
                        gainNode.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

                        oscillator.start(ctx.currentTime);
                        oscillator.stop(ctx.currentTime + 0.5);
                    }, index * 120);
                });
            },

            playPushSound() {
                if (!this.audioContext) return;

                const ctx = this.audioContext;
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = 200;
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0, ctx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.4);
            }
        };

        // ==================== æ ¸å¿ƒæ¸¸æˆç±» ====================

        const Game = {
            init() {
                GameState.canvas = document.getElementById('game-canvas');
                GameState.ctx = GameState.canvas.getContext('2d');

                // ç»‘å®šéŸ³é¢‘åˆå§‹åŒ–
                document.addEventListener('click', () => {
                    if (!AudioEngine.audioContext) {
                        AudioEngine.init();
                    }
                }, { once: true });

                // å“åº”çª—å£
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // åˆ›å»ºæ˜Ÿæ˜Ÿ
                this.createStars();

                // åŠ è½½æ€»æ˜Ÿæ•°
                this.loadStars();

                // éšè—åŠ è½½ç•Œé¢
                setTimeout(() => {
                    const loadingEl = document.getElementById('loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'none';
                    }
                }, 800);

                // å¼€å§‹æ¸²æŸ“
                this.startRenderLoop();
            },

            resizeCanvas() {
                const canvas = GameState.canvas;
                GameState.width = window.innerWidth;
                GameState.height = window.innerHeight;

                canvas.width = GameState.width;
                canvas.height = GameState.height;
            },

            switchScene(scene) {
                GameState.currentScene = scene;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('btn-tug').classList.toggle('active', scene === 'tug');
                document.getElementById('btn-push').classList.toggle('active', scene === 'push');

                // åˆ‡æ¢æ§åˆ¶é¢æ¿
                document.getElementById('tug-controls').style.display = scene === 'tug' ? 'flex' : 'none';
                document.getElementById('push-controls').style.display = scene === 'push' ? 'block' : 'none';

                // æ›´æ–°æç¤º
                if (scene === 'tug') {
                    document.getElementById('hint').textContent = 'ğŸ® æ‹”æ²³æ¯”èµ›ï¼šè°ƒæ•´åŒæ–¹äººæ•°å’ŒåŠ›é‡ï¼Œçœ‹çœ‹è°èƒ½èµ¢ï¼';
                } else {
                    document.getElementById('hint').textContent = 'ğŸ“¦ æ¨ç®±å­ï¼šé€‰æ‹©è¡¨é¢ï¼Œè°ƒèŠ‚æ‘©æ“¦åŠ›ï¼Œç„¶åæ¨ç®±å­ï¼';
                }
            },

            updateTugSettings() {
                const bluePeople = parseInt(document.getElementById('blue-people').value);
                const blueForce = parseInt(document.getElementById('blue-force').value);
                const redPeople = parseInt(document.getElementById('red-people').value);
                const redForce = parseInt(document.getElementById('red-force').value);

                document.getElementById('blue-people-value').textContent = bluePeople;
                document.getElementById('blue-force-value').textContent = blueForce;
                document.getElementById('red-people-value').textContent = redPeople;
                document.getElementById('red-force-value').textContent = redForce;

                GameState.tug.blueTeam.people = bluePeople;
                GameState.tug.blueTeam.forcePerPerson = blueForce;
                GameState.tug.blueTeam.totalForce = bluePeople * blueForce;

                GameState.tug.redTeam.people = redPeople;
                GameState.tug.redTeam.forcePerPerson = redForce;
                GameState.tug.redTeam.totalForce = redPeople * redForce;

                // å¦‚æœæ¯”èµ›å·²ç»“æŸï¼Œé‡ç½®
                if (GameState.tug.won) {
                    this.resetTug();
                }

                AudioEngine.playTugSound();
            },

            updatePushSettings() {
                const pushForce = parseInt(document.getElementById('push-force').value);
                const friction = parseFloat(document.getElementById('friction').value);

                document.getElementById('push-force-value').textContent = pushForce + ' N';
                document.getElementById('friction-value').textContent = friction.toFixed(1);

                GameState.push.appliedForce = pushForce;
                GameState.push.frictionCoefficient = friction;
            },

            updateSurface() {
                const surface = document.getElementById('surface-type').value;
                const frictionValues = {
                    ice: 0.1,
                    wood: 0.3,
                    sand: 0.5,
                    carpet: 0.7,
                    rubber: 0.9
                };

                const surfaceNames = {
                    ice: 'å†°é¢',
                    wood: 'æœ¨æ¿',
                    sand: 'æ²™åœ°',
                    carpet: 'åœ°æ¯¯',
                    rubber: 'æ©¡èƒ¶'
                };

                const friction = frictionValues[surface];
                GameState.push.frictionCoefficient = friction;
                GameState.push.surfaceName = surfaceNames[surface];

                // æ›´æ–°æ»‘å—
                document.getElementById('friction').value = friction;
                document.getElementById('friction-value').textContent = friction.toFixed(1);

                AudioEngine.playTugSound();
            },

            pushBox() {
                if (GameState.push.isPushing) return;

                GameState.push.isPushing = true;
                AudioEngine.playPushSound();

                GameState.experimentCount++;
                document.getElementById('experimentCount').textContent = GameState.experimentCount;

                // è®¡ç®—åŠ é€Ÿåº¦
                const appliedForce = GameState.push.appliedForce;
                const frictionForce = GameState.push.frictionCoefficient * GameState.push.boxMass * 9.8;
                const netForce = appliedForce - frictionForce;

                if (netForce <= 0) {
                    // æ‘©æ“¦åŠ›å¤ªå¤§ï¼Œæ¨ä¸åŠ¨
                    document.getElementById('hint').textContent = 'âš ï¸ æ‘©æ“¦åŠ›å¤ªå¤§ï¼Œæ¨ä¸åŠ¨ï¼è¯•è¯•å¢åŠ æ¨åŠ›æˆ–å‡å°‘æ‘©æ“¦åŠ›ï¼';
                    setTimeout(() => {
                        GameState.push.isPushing = false;
                        document.getElementById('hint').textContent = 'ğŸ“¦ æ¨ç®±å­ï¼šé€‰æ‹©è¡¨é¢ï¼Œè°ƒèŠ‚æ‘©æ“¦åŠ›ï¼Œç„¶åæ¨ç®±å­ï¼';
                    }, 2000);
                } else {
                    // å¯ä»¥æ¨åŠ¨
                    const acceleration = netForce / GameState.push.boxMass;
                    document.getElementById('hint').textContent = `ğŸ’¨ ç®±å­å¼€å§‹ç§»åŠ¨ï¼åŠ é€Ÿåº¦ = ${acceleration.toFixed(1)} m/sÂ²`;

                    // æ¨¡æ‹Ÿæ¨åŠ¨è¿‡ç¨‹
                    let pushTime = 0;
                    const pushInterval = setInterval(() => {
                        pushTime += 16; // ms

                        if (pushTime >= 2000) { // æ¨2ç§’
                            clearInterval(pushInterval);
                            GameState.push.isPushing = false;

                            // å¥–åŠ±æ£€æŸ¥
                            if (GameState.push.boxPosition > 300) {
                                GameState.currentStars++;
                                GameState.totalStars++;
                                document.getElementById('starCount').textContent = GameState.currentStars;

                                localStorage.setItem('totalStars', GameState.totalStars.toString());
                                document.getElementById('totalStars').textContent = GameState.totalStars;

                                AudioEngine.playWinSound();
                                this.showReward();
                            } else {
                                document.getElementById('hint').textContent = 'ğŸ“¦ æ¨ç®±å­ï¼šé€‰æ‹©è¡¨é¢ï¼Œè°ƒèŠ‚æ‘©æ“¦åŠ›ï¼Œç„¶åæ¨ç®±å­ï¼';
                            }
                        }
                    }, 16);
                }
            },

            resetTug() {
                GameState.tug.ropePosition = 0;
                GameState.tug.ropeSpeed = 0;
                GameState.tug.won = false;
                GameState.tug.winner = null;
            },

            reset() {
                if (GameState.currentScene === 'tug') {
                    this.resetTug();
                } else {
                    GameState.push.boxPosition = 0;
                    GameState.push.boxVelocity = 0;
                    GameState.push.isPushing = false;
                    document.getElementById('hint').textContent = 'ğŸ“¦ æ¨ç®±å­ï¼šé€‰æ‹©è¡¨é¢ï¼Œè°ƒèŠ‚æ‘©æ“¦åŠ›ï¼Œç„¶åæ¨ç®±å­ï¼';
                }
            },

            showHint() {
                if (GameState.currentScene === 'tug') {
                    alert('ğŸ’¡ æ‹”æ²³æ¯”èµ›æç¤ºï¼š\n\nåŠ› = äººæ•° Ã— æ¯äººåŠ›é‡\n\næ€»åŠ›æ›´å¤§çš„ä¸€æ–¹ä¼šè·èƒœï¼\n\nä¾‹å¦‚ï¼š\n- è“é˜Ÿï¼š3äººï¼Œæ¯äºº100N = 300N\n- çº¢é˜Ÿï¼š2äººï¼Œæ¯äºº150N = 300N\n- å¦‚æœåŠ›é‡ç›¸ç­‰ï¼Œç»³å­ä¼šä¿æŒå¹³è¡¡ï¼');
                } else {
                    alert('ğŸ’¡ æ¨ç®±å­æç¤ºï¼š\n\næ‘©æ“¦åŠ› = æ‘©æ“¦ç³»æ•° Ã— æ­£å‹åŠ›\n\nåŠ é€Ÿåº¦ = (æ¨åŠ› - æ‘©æ“¦åŠ›) Ã· è´¨é‡\n\nè¦æ¨åŠ¨ç®±å­ï¼Œæ¨åŠ›å¿…é¡»å¤§äºæ‘©æ“¦åŠ›ï¼\n\nå…‰æ»‘çš„è¡¨é¢ï¼ˆå¦‚å†°é¢ï¼‰æ‘©æ“¦ç³»æ•°å°ï¼Œå®¹æ˜“æ¨åŠ¨ï¼›ç²—ç³™çš„è¡¨é¢ï¼ˆå¦‚æ©¡èƒ¶ï¼‰æ‘©æ“¦ç³»æ•°å¤§ï¼Œéœ€è¦æ›´å¤§çš„æ¨åŠ›ï¼');
                }
            },

            restart() {
                document.getElementById('reward-overlay').style.display = 'none';
                this.reset();
            },

            loadStars() {
                const totalStars = localStorage.getItem('totalStars') || '0';
                GameState.totalStars = parseInt(totalStars);
                document.getElementById('totalStars').textContent = totalStars;
            },

            showReward() {
                const overlay = document.getElementById('reward-overlay');
                overlay.style.display = 'flex';
            },

            createStars() {
                const container = document.getElementById('game-container');

                for (let i = 0; i < 60; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';

                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 70 + '%';

                    const size = Math.random() * 3 + 1;
                    star.style.width = size + 'px';
                    star.style.height = size + 'px';

                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 2 + 1) + 's';

                    container.appendChild(star);
                }
            },

            startRenderLoop() {
                const render = () => {
                    this.update();
                    this.render();
                    requestAnimationFrame(render);
                };
                render();
            },

            update() {
                if (GameState.currentScene === 'tug') {
                    this.updateTug();
                } else {
                    this.updatePush();
                }
            },

            updateTug() {
                if (GameState.tug.won) return;

                const blueForce = GameState.tug.blueTeam.totalForce;
                const redForce = GameState.tug.redTeam.totalForce;
                const netForce = blueForce - redForce;

                // è®¡ç®—åŠ é€Ÿåº¦ï¼ˆç»³å­è´¨é‡å‡è®¾ä¸º10kgï¼‰
                const ropeMass = 10;
                const acceleration = netForce / ropeMass;

                // æ›´æ–°é€Ÿåº¦å’Œä½ç½®
                GameState.tug.ropeSpeed += acceleration * 0.05;
                GameState.tug.ropeSpeed *= 0.98; // é˜»å°¼
                GameState.tug.ropePosition += GameState.tug.ropeSpeed * 0.05;

                // æ£€æŸ¥èƒœè´Ÿ
                if (GameState.tug.ropePosition > 200) {
                    GameState.tug.won = true;
                    GameState.tug.winner = 'red';
                    document.getElementById('hint').textContent = 'ğŸ”´ çº¢é˜Ÿè·èƒœï¼è°ƒæ•´äººæ•°å’ŒåŠ›é‡å†æ¥ä¸€æ¬¡ï¼';

                    GameState.experimentCount++;
                    GameState.currentStars++;
                    GameState.totalStars++;
                    document.getElementById('experimentCount').textContent = GameState.experimentCount;
                    document.getElementById('starCount').textContent = GameState.currentStars;
                    localStorage.setItem('totalStars', GameState.totalStars.toString());
                    document.getElementById('totalStars').textContent = GameState.totalStars;

                    AudioEngine.playWinSound();
                    setTimeout(() => this.showReward(), 1000);
                } else if (GameState.tug.ropePosition < -200) {
                    GameState.tug.won = true;
                    GameState.tug.winner = 'blue';
                    document.getElementById('hint').textContent = 'ğŸ”µ è“é˜Ÿè·èƒœï¼è°ƒæ•´äººæ•°å’ŒåŠ›é‡å†æ¥ä¸€æ¬¡ï¼';

                    GameState.experimentCount++;
                    GameState.currentStars++;
                    GameState.totalStars++;
                    document.getElementById('experimentCount').textContent = GameState.experimentCount;
                    document.getElementById('starCount').textContent = GameState.currentStars;
                    localStorage.setItem('totalStars', GameState.totalStars.toString());
                    document.getElementById('totalStars').textContent = GameState.totalStars;

                    AudioEngine.playWinSound();
                    setTimeout(() => this.showReward(), 1000);
                }
            },

            updatePush() {
                if (!GameState.push.isPushing) return;

                const appliedForce = GameState.push.appliedForce;
                const frictionForce = GameState.push.frictionCoefficient * GameState.push.boxMass * 9.8;
                const netForce = appliedForce - frictionForce;

                if (netForce > 0) {
                    const acceleration = netForce / GameState.push.boxMass;
                    GameState.push.boxVelocity += acceleration * 0.05;
                    GameState.push.boxPosition += GameState.push.boxVelocity * 0.05;

                    // é€Ÿåº¦è¡°å‡ï¼ˆç©ºæ°”é˜»åŠ›ï¼‰
                    GameState.push.boxVelocity *= 0.995;

                    // è¾¹ç•Œæ£€æŸ¥
                    if (GameState.push.boxPosition > 500) {
                        GameState.push.boxPosition = 500;
                        GameState.push.boxVelocity = 0;
                    }
                }
            },

            render() {
                const ctx = GameState.ctx;
                const width = GameState.width;
                const height = GameState.height;

                ctx.clearRect(0, 0, width, height);

                if (GameState.currentScene === 'tug') {
                    this.renderTug(ctx, width, height);
                } else {
                    this.renderPush(ctx, width, height);
                }
            },

            renderTug(ctx, width, height) {
                // èƒŒæ™¯ - è‰åœ°
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, height * 0.7, width, height * 0.3);

                // å¤©ç©º
                const skyGradient = ctx.createLinearGradient(0, 0, 0, height * 0.7);
                skyGradient.addColorStop(0, '#87CEEB');
                skyGradient.addColorStop(1, '#E0F7FA');
                ctx.fillStyle = skyGradient;
                ctx.fillRect(0, 0, width, height * 0.7);

                // ä¸­å¿ƒçº¿
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 10]);
                ctx.beginPath();
                ctx.moveTo(width / 2, height * 0.4);
                ctx.lineTo(width / 2, height * 0.8);
                ctx.stroke();
                ctx.setLineDash([]);

                // ç»³å­
                const ropeStartX = width / 2 - 300;
                const ropeEndX = width / 2 + 300;
                const ropeY = height * 0.5;

                // ç»˜åˆ¶ç»³å­ï¼ˆå¸¦æ³¢æµªæ•ˆæœè¡¨ç¤ºå¼ åŠ›ï¼‰
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 8;
                ctx.lineCap = 'round';

                ctx.beginPath();
                ctx.moveTo(ropeStartX, ropeY);

                const tension = GameState.tug.ropePosition / 200;
                const waveAmplitude = Math.abs(tension) * 10;

                for (let x = ropeStartX; x <= ropeEndX; x += 5) {
                    const waveOffset = Math.sin((x - ropeStartX) / 20) * waveAmplitude;
                    const curveOffset = Math.pow((x - width / 2) / 300, 2) * GameState.tug.ropePosition;
                    ctx.lineTo(x, ropeY + waveOffset + curveOffset);
                }

                ctx.stroke();

                // ä¸­å¿ƒæ ‡è®°
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(width / 2 + GameState.tug.ropePosition, ropeY, 15, 0, Math.PI * 2);
                ctx.fill();

                // ç»˜åˆ¶é˜Ÿä¼
                this.drawTeam(ctx, width, height, 'blue', GameState.tug.blueTeam);
                this.drawTeam(ctx, width, height, 'red', GameState.tug.redTeam);

                // æ˜¾ç¤ºæ€»åŠ›
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';

                ctx.fillText(`ğŸ”µ ${GameState.tug.blueTeam.people}äºº Ã— ${GameState.tug.blueTeam.forcePerPerson}N = ${GameState.tug.blueTeam.totalForce}N`,
                    width * 0.25, height * 0.35);
                ctx.fillText(`ğŸ”´ ${GameState.tug.redTeam.people}äºº Ã— ${GameState.tug.redTeam.forcePerPerson}N = ${GameState.tug.redTeam.totalForce}N`,
                    width * 0.75, height * 0.35);

                // é€Ÿåº¦è¡¨
                const speedX = width / 2;
                const speedY = height * 0.25;

                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.beginPath();
                ctx.roundRect(speedX - 80, speedY - 30, 160, 60, 15);
                ctx.fill();

                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('é€Ÿåº¦', speedX, speedY - 10);

                const speed = Math.abs(GameState.tug.ropeSpeed).toFixed(1);
                const speedColor = speed > 5 ? '#e74c3c' : (speed > 2 ? '#f39c12' : '#27ae60');
                ctx.fillStyle = speedColor;
                ctx.font = 'bold 20px Arial';
                ctx.fillText(`${speed} m/s`, speedX, speedY + 15);
            },

            drawTeam(ctx, width, height, team, teamData) {
                const isLeft = team === 'blue';
                const baseX = isLeft ? width * 0.2 : width * 0.8;
                const baseY = height * 0.5;

                const teamColor = team === 'blue' ? '#3498db' : '#e74c3c';

                // ç»˜åˆ¶äºº
                for (let i = 0; i < teamData.people; i++) {
                    const offsetX = isLeft ? i * 50 : -i * 50;
                    const x = baseX + offsetX;
                    const y = baseY + i * 5;

                    // èº«ä½“
                    ctx.fillStyle = teamColor;
                    ctx.beginPath();
                    ctx.ellipse(x, y + 20, 20, 30, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // å¤´
                    ctx.fillStyle = '#FDBF6F';
                    ctx.beginPath();
                    ctx.arc(x, y - 20, 18, 0, Math.PI * 2);
                    ctx.fill();

                    // çœ¼ç›
                    ctx.fillStyle = '#2c3e50';
                    ctx.beginPath();
                    ctx.arc(isLeft ? x - 5 : x + 5, y - 22, 3, 0, Math.PI * 2);
                    ctx.fill();

                    // æ‰‹è‡‚ï¼ˆæŠ“ç»³å­ï¼‰
                    ctx.strokeStyle = teamColor;
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(isLeft ? x + 40 : x - 40, y);
                    ctx.stroke();
                }
            },

            renderPush(ctx, width, height) {
                // èƒŒæ™¯
                const surfaceColors = {
                    ice: '#E8F4F8',
                    wood: '#DEB887',
                    sand: '#F4A460',
                    carpet: '#CD853F',
                    rubber: '#2c3e50'
                };

                const surfaceColor = surfaceColors[document.getElementById('surface-type').value];

                // åœ°é¢
                ctx.fillStyle = surfaceColor;
                ctx.fillRect(0, height * 0.6, width, height * 0.4);

                // è·ç¦»æ ‡è®°
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                for (let i = 0; i <= 5; i++) {
                    const x = 100 + i * 100;
                    ctx.fillText(`${i}m`, x, height * 0.65);
                    ctx.beginPath();
                    ctx.moveTo(x, height * 0.68);
                    ctx.lineTo(x, height * 0.72);
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // ç®±å­
                const boxSize = 80;
                const boxX = 100 + GameState.push.boxPosition;
                const boxY = height * 0.6 - boxSize;

                // ç®±å­é˜´å½±
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.fillRect(boxX + 5, boxY + 5, boxSize, boxSize);

                // ç®±å­
                const boxGradient = ctx.createLinearGradient(boxX, boxY, boxX + boxSize, boxY + boxSize);
                boxGradient.addColorStop(0, '#e67e22');
                boxGradient.addColorStop(1, '#d35400');
                ctx.fillStyle = boxGradient;
                ctx.fillRect(boxX, boxY, boxSize, boxSize);

                // ç®±å­è¾¹æ¡†
                ctx.strokeStyle = '#A0522D';
                ctx.lineWidth = 3;
                ctx.strokeRect(boxX, boxY, boxSize, boxSize);

                // ç®±å­æ ‡ç­¾
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${GameState.push.boxMass}kg`, boxX + boxSize / 2, boxY + boxSize / 2 + 5);

                // äººæ¨ç®±å­
                ctx.fillStyle = '#FDBF6F';
                ctx.beginPath();
                ctx.arc(boxX - 30, boxY + 20, 18, 0, Math.PI * 2);
                ctx.fill();

                // èº«ä½“
                ctx.fillStyle = '#3498db';
                ctx.beginPath();
                ctx.ellipse(boxX - 30, boxY + 50, 15, 25, 0, 0, Math.PI * 2);
                ctx.fill();

                // æ¨çš„æ‰‹è‡‚
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(boxX - 30, boxY + 40);
                ctx.lineTo(boxX - 5, boxY + 40);
                ctx.stroke();

                // æ¨åŠ›ç®­å¤´
                if (GameState.push.isPushing) {
                    const arrowX = boxX - 60;
                    const arrowY = boxY + 40;

                    ctx.fillStyle = '#e74c3c';
                    ctx.beginPath();
                    ctx.moveTo(arrowX, arrowY);
                    ctx.lineTo(arrowX + 40, arrowY);
                    ctx.lineTo(arrowX + 30, arrowY - 10);
                    ctx.lineTo(arrowX + 40, arrowY);
                    ctx.lineTo(arrowX + 30, arrowY + 10);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${GameState.push.appliedForce}N`, arrowX + 20, arrowY - 15);
                }

                // ä¿¡æ¯é¢æ¿
                const panelX = 50;
                const panelY = 100;

                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.beginPath();
                ctx.roundRect(panelX, panelY, 250, 180, 15);
                ctx.fill();

                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('ğŸ“Š å®æ—¶æ•°æ®', panelX + 20, panelY + 30);

                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`è¡¨é¢: ${GameState.push.surfaceName}`, panelX + 20, panelY + 60);
                ctx.fillText(`æ‘©æ“¦ç³»æ•°: ${GameState.push.frictionCoefficient.toFixed(1)}`, panelX + 20, panelY + 85);
                ctx.fillText(`æ‘©æ“¦åŠ›: ${(GameState.push.frictionCoefficient * GameState.push.boxMass * 9.8).toFixed(1)} N`, panelX + 20, panelY + 110);
                ctx.fillText(`æ¨åŠ›: ${GameState.push.appliedForce} N`, panelX + 20, panelY + 135);

                const netForce = GameState.push.appliedForce - GameState.push.frictionCoefficient * GameState.push.boxMass * 9.8;
                const netForceColor = netForce > 0 ? '#27ae60' : '#e74c3c';
                ctx.fillStyle = netForceColor;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`å‡€åŠ›: ${netForce.toFixed(1)} N`, panelX + 20, panelY + 160);

                // é€Ÿåº¦å’Œä½ç½®
                const speedPanelX = width - 280;
                const speedPanelY = 100;

                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.beginPath();
                ctx.roundRect(speedPanelX, speedPanelY, 250, 100, 15);
                ctx.fill();

                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('ğŸš€ è¿åŠ¨çŠ¶æ€', speedPanelX + 20, speedPanelY + 30);

                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`ä½ç½®: ${(GameState.push.boxPosition / 100).toFixed(1)} m`, speedPanelX + 20, speedPanelY + 60);

                const velocity = GameState.push.boxVelocity.toFixed(1);
                const velocityColor = Math.abs(velocity) > 5 ? '#e74c3c' : (Math.abs(velocity) > 2 ? '#f39c12' : '#27ae60');
                ctx.fillStyle = velocityColor;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(`é€Ÿåº¦: ${velocity} m/s`, speedPanelX + 20, speedPanelY + 85);
            }
        };

        const game = Game;

        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
            try {
                game.init();
                console.log('æ¸¸æˆåˆå§‹åŒ–æˆåŠŸï¼');
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                const loadingEl = document.getElementById('loading');
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
                document.getElementById('loading-error').style.display = 'block';
            }
        });
    </script>
</body>
</html>
